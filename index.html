
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raw Wealthy Admin Dashboard</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
    <!-- Toastr CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <!-- Custom CSS -->
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            --dark-color: #1f2937;
            --light-color: #f9fafb;
            --sidebar-width: 250px;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fb;
            overflow-x: hidden;
        }
        
        /* Sidebar Styles */
        #sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            position: fixed;
            height: 100vh;
            z-index: 1000;
            transition: all 0.3s;
            box-shadow: 3px 0 20px rgba(0,0,0,0.1);
        }
        
        .sidebar-header {
            padding: 20px;
            background: rgba(0,0,0,0.2);
        }
        
        .sidebar-header h3 {
            margin: 0;
            font-weight: 600;
        }
        
        .sidebar-header h3 i {
            margin-right: 10px;
        }
        
        .sidebar-menu {
            padding: 20px 0;
        }
        
        .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 12px 20px;
            margin: 2px 0;
            border-left: 4px solid transparent;
            transition: all 0.3s;
        }
        
        .nav-link:hover, .nav-link.active {
            color: white;
            background: rgba(255,255,255,0.1);
            border-left: 4px solid white;
        }
        
        .nav-link i {
            width: 25px;
            font-size: 1.1rem;
        }
        
        .sub-menu {
            padding-left: 40px;
            background: rgba(0,0,0,0.1);
            display: none;
        }
        
        .sub-menu.show {
            display: block;
        }
        
        .sub-menu .nav-link {
            padding: 8px 20px;
            font-size: 0.9rem;
        }
        
        /* Main Content */
        #content {
            margin-left: var(--sidebar-width);
            transition: all 0.3s;
            min-height: 100vh;
        }
        
        .top-navbar {
            background: white;
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .top-navbar .navbar-brand {
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .page-title {
            margin: 20px 0;
            color: var(--dark-color);
            font-weight: 600;
        }
        
        /* Card Styles */
        .dashboard-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: transform 0.3s, box-shadow 0.3s;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .card-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
            margin-bottom: 15px;
        }
        
        .card-icon.users {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
        }
        
        .card-icon.money {
            background: linear-gradient(45deg, var(--success-color), #34d399);
        }
        
        .card-icon.investments {
            background: linear-gradient(45deg, var(--info-color), #60a5fa);
        }
        
        .card-icon.pending {
            background: linear-gradient(45deg, var(--warning-color), #fbbf24);
        }
        
        .card-stat {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark-color);
        }
        
        .card-change {
            font-size: 0.85rem;
        }
        
        .card-change.positive {
            color: var(--success-color);
        }
        
        .card-change.negative {
            color: var(--danger-color);
        }
        
        /* Chart Container */
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        /* Table Styles */
        .data-table-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .table th {
            font-weight: 600;
            color: var(--dark-color);
            border-top: none;
        }
        
        .table td {
            vertical-align: middle;
        }
        
        /* Badge Styles */
        .badge-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 500;
        }
        
        .badge-pending {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .badge-active {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .badge-approved {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .badge-rejected {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .badge-paid {
            background-color: #dcfce7;
            color: #166534;
        }
        
        .badge-verified {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        /* Button Styles */
        .btn-action {
            padding: 5px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .btn-view {
            background-color: #e0e7ff;
            color: #4f46e5;
        }
        
        .btn-approve {
            background-color: #d1fae5;
            color: #059669;
        }
        
        .btn-reject {
            background-color: #fee2e2;
            color: #dc2626;
        }
        
        .btn-edit {
            background-color: #fef3c7;
            color: #d97706;
        }
        
        /* Modal Styles */
        .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border-radius: 15px 15px 0 0;
            padding: 20px 30px;
        }
        
        .modal-title {
            font-weight: 600;
        }
        
        /* Loading Spinner */
        .spinner-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 300px;
        }
        
        /* Image Preview */
        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .image-preview {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .image-preview:hover {
            transform: scale(1.05);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            #sidebar {
                margin-left: -250px;
            }
            
            #sidebar.active {
                margin-left: 0;
            }
            
            #content {
                margin-left: 0;
            }
            
            .sidebar-toggle {
                display: block;
            }
            
            .page-title {
                font-size: 1.5rem;
            }
        }
        
        /* Animation for page transitions */
        .page-content {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 10px;
        }
        
        /* Search Box */
        .search-box {
            position: relative;
        }
        
        .search-box input {
            padding-left: 40px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
        }
        
        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }
        
        /* Filter Dropdown */
        .filter-dropdown {
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 8px 15px;
            background: white;
            color: #6b7280;
            cursor: pointer;
        }
        
        /* Stats Cards Small */
        .stats-card-sm {
            background: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        .stats-card-sm .number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark-color);
        }
        
        .stats-card-sm .label {
            font-size: 0.85rem;
            color: #6b7280;
        }
        
        /* Activity Timeline */
        .activity-timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .activity-timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -25px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary-color);
            border: 3px solid white;
            box-shadow: 0 0 0 2px var(--primary-color);
        }
        
        .timeline-item .time {
            font-size: 0.8rem;
            color: #6b7280;
        }
        
        /* User Avatar */
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1rem;
        }
        
        /* Quick Stats */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        /* Notification Bell */
        .notification-bell {
            position: relative;
            cursor: pointer;
        }
        
        .notification-bell .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger-color);
            color: white;
            font-size: 0.7rem;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <nav id="sidebar">
        <div class="sidebar-header">
            <h3><i class="fas fa-gem"></i> Raw Wealthy</h3>
            <p class="mb-0" style="opacity: 0.8; font-size: 0.9rem;">Admin Dashboard v37.0</p>
        </div>
        
        <div class="sidebar-menu">
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" href="#" data-page="dashboard">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>
                </li>
                
                <li class="nav-item">
                    <a class="nav-link" href="#" data-page="users">
                        <i class="fas fa-users"></i> Users Management
                    </a>
                </li>
                
                <li class="nav-item">
                    <a class="nav-link" href="#" data-toggle="collapse" data-target="#financialSubmenu">
                        <i class="fas fa-money-bill-wave"></i> Financial Management
                        <i class="fas fa-chevron-down float-end mt-1"></i>
                    </a>
                    <div class="sub-menu" id="financialSubmenu">
                        <a class="nav-link" href="#" data-page="investments">
                            <i class="fas fa-chart-line"></i> Investments
                        </a>
                        <a class="nav-link" href="#" data-page="deposits">
                            <i class="fas fa-arrow-down"></i> Deposits
                        </a>
                        <a class="nav-link" href="#" data-page="withdrawals">
                            <i class="fas fa-arrow-up"></i> Withdrawals
                        </a>
                        <a class="nav-link" href="#" data-page="transactions">
                            <i class="fas fa-exchange-alt"></i> Transactions
                        </a>
                    </div>
                </li>
                
                <li class="nav-item">
                    <a class="nav-link" href="#" data-page="kyc">
                        <i class="fas fa-id-card"></i> KYC Verification
                    </a>
                </li>
                
                <li class="nav-item">
                    <a class="nav-link" href="#" data-page="plans">
                        <i class="fas fa-boxes"></i> Investment Plans
                    </a>
                </li>
                
                <li class="nav-item">
                    <a class="nav-link" href="#" data-page="support">
                        <i class="fas fa-headset"></i> Support Tickets
                    </a>
                </li>
                
                <li class="nav-item">
                    <a class="nav-link" href="#" data-page="referrals">
                        <i class="fas fa-user-friends"></i> Referrals
                    </a>
                </li>
                
                <li class="nav-item">
                    <a class="nav-link" href="#" data-toggle="collapse" data-target="#systemSubmenu">
                        <i class="fas fa-cogs"></i> System
                        <i class="fas fa-chevron-down float-end mt-1"></i>
                    </a>
                    <div class="sub-menu" id="systemSubmenu">
                        <a class="nav-link" href="#" data-page="notifications">
                            <i class="fas fa-bell"></i> Notifications
                        </a>
                        <a class="nav-link" href="#" data-page="audit-logs">
                            <i class="fas fa-clipboard-list"></i> Audit Logs
                        </a>
                        <a class="nav-link" href="#" data-page="settings">
                            <i class="fas fa-sliders-h"></i> Settings
                        </a>
                    </div>
                </li>
            </ul>
        </div>
        
        <div class="sidebar-footer" style="position: absolute; bottom: 20px; width: 100%; padding: 20px;">
            <div class="d-flex align-items-center">
                <div class="user-avatar me-3">
                    <span id="adminInitials">A</span>
                </div>
                <div>
                    <h6 class="mb-0" id="adminName">Admin User</h6>
                    <small style="opacity: 0.7;" id="adminRole">Super Admin</small>
                </div>
            </div>
            <button class="btn btn-sm btn-light w-100 mt-3" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </nav>
    
    <!-- Main Content -->
    <div id="content">
        <!-- Top Navbar -->
        <nav class="top-navbar">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <button class="btn btn-outline-primary d-md-none" id="sidebarToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h4 class="d-inline-block ms-3 page-title" id="pageTitle">Dashboard</h4>
                </div>
                
                <div class="d-flex align-items-center">
                    <div class="notification-bell me-3">
                        <i class="fas fa-bell fa-lg text-muted"></i>
                        <span class="badge" id="notificationCount">3</span>
                    </div>
                    <div class="search-box me-3">
                        <i class="fas fa-search"></i>
                        <input type="text" class="form-control" placeholder="Search..." id="globalSearch">
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="filterDropdown" data-bs-toggle="dropdown">
                            <i class="fas fa-filter"></i> Filters
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" data-filter="all">All</a></li>
                            <li><a class="dropdown-item" href="#" data-filter="today">Today</a></li>
                            <li><a class="dropdown-item" href="#" data-filter="week">This Week</a></li>
                            <li><a class="dropdown-item" href="#" data-filter="month">This Month</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>
        
        <!-- Page Content -->
        <div class="container-fluid p-4">
            <div id="pageContent">
                <!-- Content will be loaded here dynamically -->
                <div class="spinner-container">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    
    <!-- User Details Modal -->
    <div class="modal fade" id="userDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">User Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="userDetailsContent">
                    <!-- User details will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Approve/Reject Modal -->
    <div class="modal fade" id="actionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="actionModalTitle">Action</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="actionModalContent">
                        <!-- Content will be loaded here -->
                    </div>
                    <div class="mt-3">
                        <label for="actionRemarks" class="form-label">Remarks (Optional)</label>
                        <textarea class="form-control" id="actionRemarks" rows="3" placeholder="Enter remarks..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="rejectBtn">Reject</button>
                    <button type="button" class="btn btn-success" id="approveBtn">Approve</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Image Preview Modal -->
    <div class="modal fade" id="imagePreviewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Image Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img src="" alt="Preview" id="previewImage" class="img-fluid" style="max-height: 70vh;">
                </div>
            </div>
        </div>
    </div>
    
    <!-- Send Notification Modal -->
    <div class="modal fade" id="sendNotificationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Send Notification</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="notificationForm">
                        <div class="mb-3">
                            <label for="notificationTitle" class="form-label">Title</label>
                            <input type="text" class="form-control" id="notificationTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="notificationMessage" class="form-label">Message</label>
                            <textarea class="form-control" id="notificationMessage" rows="4" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="notificationType" class="form-label">Type</label>
                            <select class="form-select" id="notificationType">
                                <option value="info">Info</option>
                                <option value="success">Success</option>
                                <option value="warning">Warning</option>
                                <option value="error">Error</option>
                                <option value="promotional">Promotional</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="notificationTarget" class="form-label">Send To</label>
                            <select class="form-select" id="notificationTarget">
                                <option value="all">All Users</option>
                                <option value="specific">Specific User</option>
                            </select>
                        </div>
                        <div class="mb-3" id="specificUserField" style="display: none;">
                            <label for="specificUserId" class="form-label">User ID</label>
                            <input type="text" class="form-control" id="specificUserId" placeholder="Enter user ID">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="sendNotificationBtn">Send</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Update Balance Modal -->
    <div class="modal fade" id="updateBalanceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Update User Balance</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="updateBalanceForm">
                        <div class="mb-3">
                            <label class="form-label">User</label>
                            <input type="text" class="form-control" id="balanceUserName" readonly>
                            <input type="hidden" id="balanceUserId">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Current Balance</label>
                            <input type="text" class="form-control" id="currentBalance" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="balanceAction" class="form-label">Action</label>
                            <select class="form-select" id="balanceAction">
                                <option value="add">Add Funds</option>
                                <option value="subtract">Subtract Funds</option>
                                <option value="set">Set New Balance</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="balanceAmount" class="form-label">Amount (₦)</label>
                            <input type="number" class="form-control" id="balanceAmount" required min="0" step="0.01">
                        </div>
                        <div class="mb-3">
                            <label for="balanceDescription" class="form-label">Description</label>
                            <input type="text" class="form-control" id="balanceDescription" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="updateBalanceBtn">Update</button>
                </div>
            </div>
        </div>
    </div>
<script>
    <!-- Scripts -->
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- DataTables -->
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <!-- Toastr -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script><script>
    // Configuration
    const API_BASE_URL = 'https://real-wealthy-1.onrender.com'; // Same as server
    const API_ENDPOINTS = {
        // Auth
        login: '/api/auth/login',
        profile: '/api/profile',
        
        // Dashboard
        adminDashboard: '/api/admin/dashboard',
        adminUserDashboard: (id) => `/api/admin/users/${id}/dashboard`,
        
        // Users
        adminUsers: '/api/admin/users',
        adminUserDetails: (id) => `/api/admin/users/${id}`,
        updateUserBalance: (id) => `/api/admin/users/${id}/balance`,
        verifyBank: (id) => `/api/admin/users/${id}/verify-bank`,
        updateUserRole: (id) => `/api/admin/users/${id}/role`,
        updateUserStatus: (id) => `/api/admin/users/${id}/status`,
        
        // Investments
        adminInvestments: '/api/admin/pending-investments',
        adminAllInvestments: '/api/admin/investments',
        approveInvestment: (id) => `/api/admin/investments/${id}/approve`,
        rejectInvestment: (id) => `/api/admin/investments/${id}/reject`,
        
        // Deposits
        adminDeposits: '/api/admin/pending-deposits',
        adminAllDeposits: '/api/admin/deposits',
        approveDeposit: (id) => `/api/admin/deposits/${id}/approve`,
        rejectDeposit: (id) => `/api/admin/deposits/${id}/reject`,
        
        // Withdrawals
        adminWithdrawals: '/api/admin/pending-withdrawals',
        adminAllWithdrawals: '/api/admin/withdrawals',
        approveWithdrawal: (id) => `/api/admin/withdrawals/${id}/approve`,
        rejectWithdrawal: (id) => `/api/admin/withdrawals/${id}/reject`,
        
        // Transactions
        adminTransactions: '/api/admin/transactions',
        userTransactions: '/api/transactions',
        
        // KYC
        adminKYC: '/api/admin/pending-kyc',
        approveKYC: (id) => `/api/admin/kyc/${id}/approve`,
        rejectKYC: (id) => `/api/admin/kyc/${id}/reject`,
        kycStatus: '/api/kyc/status',
        
        // Plans
        investmentPlans: '/api/plans',
        
        // Support
        supportTickets: '/api/support/tickets',
        
        // Referrals
        referralsStats: '/api/referrals/stats',
        
        // Notifications
        notifications: '/api/notifications',
        markNotificationRead: (id) => `/api/notifications/${id}/read`,
        markAllNotificationsRead: '/api/notifications/read-all',
        sendNotification: '/api/admin/notifications/send',
        
        // Upload
        uploadFile: '/api/upload',
        uploadMultiple: '/api/upload/multiple'
    };

    // Global State
    let currentUser = null;
    let authToken = localStorage.getItem('admin_token');
    let currentPage = 'dashboard';
    let currentFilter = 'all';
    let dataTables = {};
    let charts = {};
    let pendingActions = {
        investments: 0,
        deposits: 0,
        withdrawals: 0,
        kyc: 0
    };

    // Toastr Configuration
    toastr.options = {
        "closeButton": true,
        "debug": false,
        "newestOnTop": true,
        "progressBar": true,
        "positionClass": "toast-top-right",
        "preventDuplicates": false,
        "onclick": null,
        "showDuration": "300",
        "hideDuration": "1000",
        "timeOut": "5000",
        "extendedTimeOut": "1000",
        "showEasing": "swing",
        "hideEasing": "linear",
        "showMethod": "fadeIn",
        "hideMethod": "fadeOut"
    };

    // Initialize Application
    $(document).ready(function() {
        checkAuth();
        initEventListeners();
    });

    // ==================== AUTHENTICATION ====================
    function checkAuth() {
        if (!authToken) {
            showLoginPage();
        } else {
            verifyToken();
        }
    }

    function showLoginPage() {
        $('#sidebar').hide();
        $('#content').html(`
            <div class="container">
                <div class="row justify-content-center align-items-center min-vh-100">
                    <div class="col-md-6 col-lg-4">
                        <div class="card dashboard-card">
                            <div class="card-body p-5">
                                <div class="text-center mb-4">
                                    <h3 class="fw-bold" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                                        <i class="fas fa-gem"></i> Raw Wealthy
                                    </h3>
                                    <p class="text-muted">Admin Dashboard v37.0</p>
                                </div>
                                
                                <form id="loginForm">
                                    <div class="mb-3">
                                        <label for="loginEmail" class="form-label">Email Address</label>
                                        <input type="email" class="form-control" id="loginEmail" required value="admin@rawwealthy.com">
                                    </div>
                                    <div class="mb-3">
                                        <label for="loginPassword" class="form-label">Password</label>
                                        <input type="password" class="form-control" id="loginPassword" required value="Admin123456">
                                    </div>
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-primary btn-lg">
                                            <i class="fas fa-sign-in-alt"></i> Login
                                        </button>
                                    </div>
                                </form>
                                
                                <div class="mt-3 text-center">
                                    <small class="text-muted">Default: admin@rawwealthy.com / Admin123456</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `);

        $('#loginForm').on('submit', function(e) {
            e.preventDefault();
            login();
        });
    }

    async function login() {
        const email = $('#loginEmail').val();
        const password = $('#loginPassword').val();

        try {
            const response = await fetch(`${API_BASE_URL}${API_ENDPOINTS.login}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email, password })
            });

            const data = await response.json();

            if (data.success && (data.data.user.role === 'admin' || data.data.user.role === 'super_admin')) {
                authToken = data.data.token;
                localStorage.setItem('admin_token', authToken);
                currentUser = data.data.user;
                updateAdminProfile();
                loadPage('dashboard');
                toastr.success('Login successful!');
            } else {
                toastr.error('Invalid credentials or insufficient privileges');
            }
        } catch (error) {
            toastr.error('Login failed. Please try again.');
        }
    }

    async function verifyToken() {
        try {
            const data = await makeRequest(API_ENDPOINTS.profile);
            
            if (data.success && (data.data.user.role === 'admin' || data.data.user.role === 'super_admin')) {
                currentUser = data.data.user;
                updateAdminProfile();
                loadPage('dashboard');
            } else {
                localStorage.removeItem('admin_token');
                showLoginPage();
            }
        } catch (error) {
            localStorage.removeItem('admin_token');
            showLoginPage();
        }
    }

    function logout() {
        localStorage.removeItem('admin_token');
        authToken = null;
        currentUser = null;
        showLoginPage();
    }

    function updateAdminProfile() {
        if (currentUser) {
            $('#adminInitials').text(currentUser.full_name.charAt(0).toUpperCase());
            $('#adminName').text(currentUser.full_name);
            $('#adminRole').text(currentUser.role === 'super_admin' ? 'Super Admin' : 'Admin');
        }
    }

    // ==================== EVENT LISTENERS ====================
    function initEventListeners() {
        // Sidebar toggle
        $('#sidebarToggle').click(function() {
            $('#sidebar').toggleClass('active');
        });

        // Navigation
        $('.nav-link[data-page]').click(function(e) {
            e.preventDefault();
            const page = $(this).data('page');
            loadPage(page);
            
            // Update active state
            $('.nav-link').removeClass('active');
            $(this).addClass('active');
            
            // Close mobile sidebar
            if ($(window).width() < 768) {
                $('#sidebar').removeClass('active');
            }
        });

        // Submenu toggle
        $('.nav-link[data-toggle="collapse"]').click(function(e) {
            e.preventDefault();
            const target = $(this).data('target');
            $(target).toggleClass('show');
            $(this).find('.fa-chevron-down').toggleClass('fa-chevron-up');
        });

        // Logout button
        $('#logoutBtn').click(logout);

        // Global search
        $('#globalSearch').on('keyup', function() {
            const searchTerm = $(this).val().toLowerCase();
            filterCurrentPage(searchTerm);
        });

        // Filter dropdown
        $('.dropdown-item[data-filter]').click(function(e) {
            e.preventDefault();
            currentFilter = $(this).data('filter');
            $('#filterDropdown').text($(this).text());
            loadPage(currentPage);
        });

        // Notification bell
        $('.notification-bell').click(function() {
            loadPage('notifications');
        });

        // Image preview
        $(document).on('click', '.image-preview', function() {
            const src = $(this).attr('src');
            $('#previewImage').attr('src', src);
            $('#imagePreviewModal').modal('show');
        });

        // Action modal buttons
        $('#approveBtn').click(performApproveAction);
        $('#rejectBtn').click(performRejectAction);

        // Notification target toggle
        $('#notificationTarget').change(function() {
            if ($(this).val() === 'specific') {
                $('#specificUserField').show();
            } else {
                $('#specificUserField').hide();
            }
        });

        // Send notification
        $('#sendNotificationBtn').click(sendNotification);

        // Update balance
        $('#updateBalanceBtn').click(updateUserBalance);
        
        // View all pending links
        $(document).on('click', '.view-all-pending', function(e) {
            e.preventDefault();
            const type = $(this).data('type');
            loadPage(type);
        });
    }

    // ==================== API HELPER FUNCTIONS ====================
    async function makeRequest(endpoint, method = 'GET', data = null, isFormData = false) {
        const options = {
            method: method,
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        };

        if (!isFormData) {
            options.headers['Content-Type'] = 'application/json';
        }

        if (data) {
            options.body = isFormData ? data : JSON.stringify(data);
        }

        try {
            const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
            
            if (response.status === 401) {
                logout();
                throw new Error('Session expired. Please login again.');
            }

            const result = await response.json();
            
            if (!result.success && result.message) {
                throw new Error(result.message);
            }
            
            return result;
        } catch (error) {
            console.error('API Error:', error);
            throw error;
        }
    }

    // ==================== PAGE LOADING ====================
    async function loadPage(page) {
        currentPage = page;
        $('#pageTitle').text(formatPageTitle(page));
        
        // Show loading spinner
        $('#pageContent').html(`
            <div class="spinner-container">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        `);

        try {
            let content = '';
            
            switch(page) {
                case 'dashboard':
                    content = await loadDashboard();
                    break;
                case 'users':
                    content = await loadUsers();
                    break;
                case 'investments':
                    content = await loadInvestments();
                    break;
                case 'deposits':
                    content = await loadDeposits();
                    break;
                case 'withdrawals':
                    content = await loadWithdrawals();
                    break;
                case 'transactions':
                    content = await loadTransactions();
                    break;
                case 'kyc':
                    content = await loadKYC();
                    break;
                case 'plans':
                    content = await loadPlans();
                    break;
                case 'support':
                    content = await loadSupportTickets();
                    break;
                case 'referrals':
                    content = await loadReferrals();
                    break;
                case 'notifications':
                    content = await loadNotifications();
                    break;
                case 'audit-logs':
                    content = await loadAuditLogs();
                    break;
                case 'settings':
                    content = await loadSettings();
                    break;
                default:
                    content = '<div class="alert alert-info">Page not found</div>';
            }
            
            $('#pageContent').html(content);
            initializePageComponents();
        } catch (error) {
            console.error('Error loading page:', error);
            $('#pageContent').html(`
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-triangle"></i> Error loading page</h5>
                    <p>${error.message}</p>
                    <button class="btn btn-primary mt-2" onclick="loadPage('${page}')">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            `);
        }
    }

    function formatPageTitle(page) {
        const titles = {
            'dashboard': 'Dashboard',
            'users': 'Users Management',
            'investments': 'Investments',
            'deposits': 'Deposits',
            'withdrawals': 'Withdrawals',
            'transactions': 'Transactions',
            'kyc': 'KYC Verification',
            'plans': 'Investment Plans',
            'support': 'Support Tickets',
            'referrals': 'Referrals System',
            'notifications': 'Notifications',
            'audit-logs': 'Audit Logs',
            'settings': 'System Settings'
        };
        return titles[page] || page.replace('_', ' ').toUpperCase();
    }

    // ==================== DASHBOARD PAGE ====================
    async function loadDashboard() {
        try {
            const data = await makeRequest(API_ENDPOINTS.adminDashboard);
            
            if (!data.success) throw new Error(data.message);
            
            const stats = data.data.stats;
            
            // Update notification count
            updateNotificationCount(stats.pending_actions);
            
            return `
                <div class="page-content">
                    <!-- Quick Stats -->
                    <div class="quick-stats">
                        <div class="stats-card-sm">
                            <div class="number">${stats.overview.total_users}</div>
                            <div class="label">Total Users</div>
                        </div>
                        <div class="stats-card-sm">
                            <div class="number">${stats.overview.active_investments}</div>
                            <div class="label">Active Investments</div>
                        </div>
                        <div class="stats-card-sm">
                            <div class="number">₦${formatNumber(stats.overview.total_active_value)}</div>
                            <div class="label">Active Value</div>
                        </div>
                        <div class="stats-card-sm">
                            <div class="number">${stats.pending_actions.total_pending}</div>
                            <div class="label">Pending Actions</div>
                        </div>
                    </div>
                    
                    <!-- Main Stats Cards -->
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card dashboard-card">
                                <div class="card-body">
                                    <div class="card-icon users">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <h6 class="card-subtitle mb-2 text-muted">Total Users</h6>
                                    <h4 class="card-stat">${stats.overview.total_users}</h4>
                                    <div class="card-change ${stats.overview.new_users_today > 0 ? 'positive' : 'negative'}">
                                        <i class="fas fa-arrow-${stats.overview.new_users_today > 0 ? 'up' : 'down'}"></i> 
                                        ${stats.overview.new_users_today} today
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="card dashboard-card">
                                <div class="card-body">
                                    <div class="card-icon money">
                                        <i class="fas fa-money-bill-wave"></i>
                                    </div>
                                    <h6 class="card-subtitle mb-2 text-muted">Platform Revenue</h6>
                                    <h4 class="card-stat">₦${formatNumber(stats.overview.platform_revenue)}</h4>
                                    <div class="card-change positive">
                                        <i class="fas fa-arrow-up"></i> Last 7 days
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="card dashboard-card">
                                <div class="card-body">
                                    <div class="card-icon investments">
                                        <i class="fas fa-chart-line"></i>
                                    </div>
                                    <h6 class="card-subtitle mb-2 text-muted">Total Investments</h6>
                                    <h4 class="card-stat">${stats.overview.total_investments}</h4>
                                    <div class="card-change positive">
                                        <i class="fas fa-arrow-up"></i> ${stats.period_stats.weekly.investments_count} this week
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="card dashboard-card">
                                <div class="card-body">
                                    <div class="card-icon pending">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                    <h6 class="card-subtitle mb-2 text-muted">Pending Actions</h6>
                                    <h4 class="card-stat">${stats.pending_actions.total_pending}</h4>
                                    <div class="card-change ${stats.pending_actions.total_pending > 0 ? 'negative' : 'positive'}">
                                        <i class="fas fa-${stats.pending_actions.total_pending > 0 ? 'exclamation-circle' : 'check-circle'}"></i> 
                                        ${stats.pending_actions.total_pending > 0 ? 'Needs attention' : 'All clear'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts and Pending Actions -->
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="chart-container">
                                <h5><i class="fas fa-chart-line"></i> Weekly Performance</h5>
                                <canvas id="weeklyChart" height="250"></canvas>
                            </div>
                        </div>
                        
                        <div class="col-lg-4">
                            <div class="data-table-container">
                                <h5><i class="fas fa-tasks"></i> Pending Actions</h5>
                                <div class="list-group">
                                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="loadPage('investments')">
                                        <div>
                                            <i class="fas fa-chart-line me-2"></i>
                                            Pending Investments
                                        </div>
                                        <span class="badge bg-warning rounded-pill">${stats.pending_actions.pending_investments}</span>
                                    </a>
                                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="loadPage('deposits')">
                                        <div>
                                            <i class="fas fa-arrow-down me-2"></i>
                                            Pending Deposits
                                        </div>
                                        <span class="badge bg-warning rounded-pill">${stats.pending_actions.pending_deposits}</span>
                                    </a>
                                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="loadPage('withdrawals')">
                                        <div>
                                            <i class="fas fa-arrow-up me-2"></i>
                                            Pending Withdrawals
                                        </div>
                                        <span class="badge bg-warning rounded-pill">${stats.pending_actions.pending_withdrawals}</span>
                                    </a>
                                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="loadPage('kyc')">
                                        <div>
                                            <i class="fas fa-id-card me-2"></i>
                                            Pending KYC
                                        </div>
                                        <span class="badge bg-warning rounded-pill">${stats.pending_actions.pending_kyc}</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Activity -->
                    <div class="row mt-4">
                        <div class="col-lg-6">
                            <div class="data-table-container">
                                <h5><i class="fas fa-user-clock"></i> Recent Users</h5>
                                <div class="table-responsive">
                                    <table class="table table-hover" id="recentUsersTable">
                                        <thead>
                                            <tr>
                                                <th>User</th>
                                                <th>Email</th>
                                                <th>Joined</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${stats.recent_activity.users.map(user => `
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="user-avatar me-2">
                                                                ${user.full_name ? user.full_name.charAt(0).toUpperCase() : 'U'}
                                                            </div>
                                                            <div>
                                                                <strong>${user.full_name || 'Unknown'}</strong><br>
                                                                <small class="text-muted">${user.phone || 'No phone'}</small>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>${user.email || 'N/A'}</td>
                                                    <td>${formatDate(user.createdAt)}</td>
                                                    <td>
                                                        <span class="badge-status ${user.is_active ? 'badge-active' : 'badge-rejected'}">
                                                            ${user.is_active ? 'Active' : 'Inactive'}
                                                        </span>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-6">
                            <div class="data-table-container">
                                <h5><i class="fas fa-exchange-alt"></i> Recent Transactions</h5>
                                <div class="activity-timeline">
                                    ${stats.recent_activity.transactions.slice(0, 8).map(txn => `
                                        <div class="timeline-item">
                                            <div class="d-flex justify-content-between">
                                                <strong>${txn.description || 'Transaction'}</strong>
                                                <span class="time">${formatDate(txn.createdAt, true)}</span>
                                            </div>
                                            <div class="d-flex justify-content-between">
                                                <small class="text-muted">${txn.user?.full_name || 'System'}</small>
                                                <span class="${txn.amount > 0 ? 'text-success' : 'text-danger'}">
                                                    ${txn.amount > 0 ? '+' : ''}₦${formatNumber(Math.abs(txn.amount))}
                                                </span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } catch (error) {
            return `
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-triangle"></i> Error loading dashboard</h5>
                    <p>${error.message}</p>
                    <button class="btn btn-primary mt-2" onclick="loadDashboard()">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            `;
        }
    }

    // ==================== USERS MANAGEMENT ====================
    async function loadUsers() {
        try {
            const queryParams = new URLSearchParams();
            if (currentFilter !== 'all') {
                if (currentFilter === 'active') queryParams.append('status', 'active');
                if (currentFilter === 'inactive') queryParams.append('status', 'inactive');
            }
            
            const queryString = queryParams.toString();
            const endpoint = queryString ? `${API_ENDPOINTS.adminUsers}?${queryString}` : API_ENDPOINTS.adminUsers;
            
            const data = await makeRequest(endpoint);
            
            if (!data.success) throw new Error(data.message);
            
            return `
                <div class="page-content">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5><i class="fas fa-users"></i> Users Management (${data.data.users.length})</h5>
                        <div>
                            <button class="btn btn-primary" onclick="exportData('users')">
                                <i class="fas fa-download"></i> Export CSV
                            </button>
                            <button class="btn btn-success ms-2" onclick="refreshData()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stats-card-sm">
                                <div class="number">${data.data.summary?.total_users || data.data.users.length}</div>
                                <div class="label">Total Users</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card-sm">
                                <div class="number">${data.data.summary?.active_users || data.data.users.filter(u => u.is_active).length}</div>
                                <div class="label">Active Users</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card-sm">
                                <div class="number">${data.data.summary?.verified_users || data.data.users.filter(u => u.kyc_verified).length}</div>
                                <div class="label">Verified Users</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card-sm">
                                <div class="number">₦${formatNumber(data.data.summary?.total_balance || data.data.users.reduce((sum, u) => sum + (u.balance || 0), 0))}</div>
                                <div class="label">Total Balance</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="data-table-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="btn-group">
                                <button class="btn btn-sm ${currentFilter === 'all' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('all')">All</button>
                                <button class="btn btn-sm ${currentFilter === 'active' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('active')">Active</button>
                                <button class="btn btn-sm ${currentFilter === 'inactive' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('inactive')">Inactive</button>
                                <button class="btn btn-sm ${currentFilter === 'verified' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('verified')">Verified</button>
                                <button class="btn btn-sm ${currentFilter === 'unverified' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('unverified')">Unverified</button>
                            </div>
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" class="form-control" placeholder="Search users..." id="usersSearch">
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover" id="usersTable">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Email</th>
                                        <th>Balance</th>
                                        <th>Status</th>
                                        <th>KYC</th>
                                        <th>Joined</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.data.users.map(user => {
                                        const userStats = user.stats || {};
                                        return `
                                            <tr>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="user-avatar me-2">
                                                            ${user.full_name ? user.full_name.charAt(0).toUpperCase() : 'U'}
                                                        </div>
                                                        <div>
                                                            <strong>${user.full_name || 'Unknown'}</strong><br>
                                                            <small class="text-muted">${user.phone || 'No phone'}</small>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>${user.email}</td>
                                                <td>
                                                    <strong>₦${formatNumber(user.balance || 0)}</strong><br>
                                                    <small class="text-muted">Portfolio: ₦${formatNumber(userStats.portfolio_value || 0)}</small>
                                                </td>
                                                <td>
                                                    <span class="badge-status ${user.is_active ? 'badge-active' : 'badge-rejected'}">
                                                        ${user.is_active ? 'Active' : 'Inactive'}
                                                    </span><br>
                                                    <small class="text-muted">${user.role}</small>
                                                </td>
                                                <td>
                                                    <span class="badge-status ${user.kyc_verified ? 'badge-verified' : 'badge-pending'}">
                                                        ${user.kyc_status || 'Not Submitted'}
                                                    </span>
                                                </td>
                                                <td>${formatDate(user.createdAt)}</td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-action btn-view" onclick="viewUserDetails('${user._id}')" title="View Details">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                        <button class="btn btn-action btn-edit" onclick="updateUserBalanceModal('${user._id}', '${user.full_name || user.email}', ${user.balance || 0})" title="Update Balance">
                                                            <i class="fas fa-coins"></i>
                                                        </button>
                                                        <div class="dropdown">
                                                            <button class="btn btn-action" type="button" data-bs-toggle="dropdown" title="More Actions">
                                                                <i class="fas fa-ellipsis-v"></i>
                                                            </button>
                                                            <ul class="dropdown-menu">
                                                                <li>
                                                                    <a class="dropdown-item" href="#" onclick="toggleUserStatus('${user._id}', ${!user.is_active})">
                                                                        ${user.is_active ? 
                                                                            '<i class="fas fa-ban text-danger"></i> Deactivate' : 
                                                                            '<i class="fas fa-check text-success"></i> Activate'}
                                                                    </a>
                                                                </li>
                                                                <li>
                                                                    <a class="dropdown-item" href="#" onclick="changeUserRole('${user._id}')">
                                                                        <i class="fas fa-user-tag"></i> Change Role
                                                                    </a>
                                                                </li>
                                                                ${user.bank_details?.account_number ? `
                                                                    <li>
                                                                        <a class="dropdown-item" href="#" onclick="verifyBankDetails('${user._id}', ${!user.bank_details?.verified})">
                                                                            ${user.bank_details?.verified ? 
                                                                                '<i class="fas fa-times text-danger"></i> Unverify Bank' : 
                                                                                '<i class="fas fa-check text-success"></i> Verify Bank'}
                                                                        </a>
                                                                    </li>
                                                                ` : ''}
                                                                <li>
                                                                    <a class="dropdown-item" href="#" onclick="viewUserDashboard('${user._id}')">
                                                                        <i class="fas fa-tachometer-alt"></i> View Dashboard
                                                                    </a>
                                                                </li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        } catch (error) {
            return `
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-triangle"></i> Error loading users</h5>
                    <p>${error.message}</p>
                    <button class="btn btn-primary mt-2" onclick="loadUsers()">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            `;
        }
    }

    // ==================== INVESTMENTS MANAGEMENT ====================
    async function loadInvestments() {
        try {
            let pendingData, allData;
            
            // Load pending investments
            pendingData = await makeRequest(API_ENDPOINTS.adminInvestments);
            
            // Load all investments based on filter
            let endpoint = API_ENDPOINTS.adminInvestments; // Default to pending
            if (currentFilter === 'active') endpoint += '?status=active';
            else if (currentFilter === 'completed') endpoint += '?status=completed';
            else if (currentFilter === 'all') {
                // We need to get all investments - this endpoint might not exist
                // For now, we'll use pending endpoint with all status
                endpoint = API_ENDPOINTS.adminInvestments;
            }
            
            allData = await makeRequest(endpoint);
            
            return `
                <div class="page-content">
                    <h5 class="mb-4"><i class="fas fa-chart-line"></i> Investments Management</h5>
                    
                    <!-- Pending Investments -->
                    ${pendingData.data?.investments?.length > 0 ? `
                        <div class="alert alert-warning mb-4">
                            <h6><i class="fas fa-exclamation-triangle"></i> ${pendingData.data.count} Pending Investments Require Approval</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>User</th>
                                            <th>Plan</th>
                                            <th>Amount</th>
                                            <th>Proof</th>
                                            <th>Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${pendingData.data.investments.slice(0, 5).map(inv => `
                                            <tr>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="user-avatar me-2">
                                                            ${inv.user_details?.name?.charAt(0)?.toUpperCase() || 'U'}
                                                        </div>
                                                        <div>
                                                            <strong>${inv.user_details?.name || 'Unknown'}</strong><br>
                                                            <small class="text-muted">${inv.user_details?.email || ''}</small>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>${inv.plan?.name || 'N/A'}</td>
                                                <td><strong>₦${formatNumber(inv.amount)}</strong></td>
                                                <td>
                                                    ${inv.has_proof ? `
                                                        <button class="btn btn-sm btn-outline-primary" onclick="viewImage('${inv.proof_url}')">
                                                            <i class="fas fa-image"></i> View
                                                        </button>
                                                    ` : '<span class="text-muted">No proof</span>'}
                                                </td>
                                                <td>${formatDate(inv.createdAt)}</td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-success" onclick="showActionModal('investment', '${inv._id}', 'approve')">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                        <button class="btn btn-danger" onclick="showActionModal('investment', '${inv._id}', 'reject')">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                        <button class="btn btn-info" onclick="viewInvestmentDetails('${inv._id}')">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            ${pendingData.data.count > 5 ? `
                                <div class="text-center mt-2">
                                    <a href="#" class="text-warning view-all-pending" data-type="investments">
                                        View all ${pendingData.data.count} pending investments
                                    </a>
                                </div>
                            ` : ''}
                        </div>
                    ` : '<div class="alert alert-success mb-4"><i class="fas fa-check-circle"></i> No pending investments at the moment.</div>'}
                    
                    <!-- All Investments -->
                    <div class="data-table-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6>All Investments</h6>
                            <div class="btn-group">
                                <button class="btn btn-sm ${currentFilter === 'all' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('all')">All</button>
                                <button class="btn btn-sm ${currentFilter === 'pending' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('pending')">Pending</button>
                                <button class="btn btn-sm ${currentFilter === 'active' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('active')">Active</button>
                                <button class="btn btn-sm ${currentFilter === 'completed' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('completed')">Completed</button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover" id="investmentsTable">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Plan</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Start Date</th>
                                        <th>End Date</th>
                                        <th>Earnings</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${allData.data?.investments?.map(inv => `
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="user-avatar me-2">
                                                        ${inv.user_details?.name?.charAt(0)?.toUpperCase() || 'U'}
                                                    </div>
                                                    <div>
                                                        <strong>${inv.user_details?.name || 'Unknown'}</strong><br>
                                                        <small class="text-muted">${inv.user_details?.email || ''}</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>${inv.plan?.name || 'N/A'}</td>
                                            <td><strong>₦${formatNumber(inv.amount)}</strong></td>
                                            <td>
                                                <span class="badge-status badge-${inv.status}">
                                                    ${inv.status}
                                                </span>
                                            </td>
                                            <td>${formatDate(inv.start_date)}</td>
                                            <td>${formatDate(inv.end_date)}</td>
                                            <td>
                                                <small>Earned: ₦${formatNumber(inv.earned_so_far || 0)}</small><br>
                                                <small>Expected: ₦${formatNumber(inv.expected_earnings || 0)}</small>
                                            </td>
                                            <td>
                                                ${inv.status === 'pending' ? `
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-success" onclick="showActionModal('investment', '${inv._id}', 'approve')">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                        <button class="btn btn-danger" onclick="showActionModal('investment', '${inv._id}', 'reject')">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                ` : `
                                                    <button class="btn btn-sm btn-outline-primary" onclick="viewInvestmentDetails('${inv._id}')">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                `}
                                            </td>
                                        </tr>
                                    `).join('') || '<tr><td colspan="8" class="text-center">No investments found</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        } catch (error) {
            return `
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-triangle"></i> Error loading investments</h5>
                    <p>${error.message}</p>
                    <button class="btn btn-primary mt-2" onclick="loadInvestments()">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            `;
        }
    }

    // ==================== DEPOSITS MANAGEMENT ====================
    async function loadDeposits() {
        try {
            let pendingData, allData;
            
            // Load pending deposits
            pendingData = await makeRequest(API_ENDPOINTS.adminDeposits);
            
            // Load all deposits based on filter
            let endpoint = API_ENDPOINTS.adminDeposits; // Default to pending
            if (currentFilter === 'approved') endpoint += '?status=approved';
            else if (currentFilter === 'rejected') endpoint += '?status=rejected';
            else if (currentFilter === 'all') {
                endpoint = API_ENDPOINTS.adminDeposits;
            }
            
            allData = await makeRequest(endpoint);
            
            return `
                <div class="page-content">
                    <h5 class="mb-4"><i class="fas fa-arrow-down"></i> Deposits Management</h5>
                    
                    <!-- Pending Deposits -->
                    ${pendingData.data?.deposits?.length > 0 ? `
                        <div class="alert alert-warning mb-4">
                            <h6><i class="fas fa-exclamation-triangle"></i> ${pendingData.data.count} Pending Deposits Require Approval</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>User</th>
                                            <th>Amount</th>
                                            <th>Method</th>
                                            <th>Proof</th>
                                            <th>Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${pendingData.data.deposits.slice(0, 5).map(dep => `
                                            <tr>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="user-avatar me-2">
                                                            ${dep.user_details?.name?.charAt(0)?.toUpperCase() || 'U'}
                                                        </div>
                                                        <div>
                                                            <strong>${dep.user_details?.name || 'Unknown'}</strong><br>
                                                            <small class="text-muted">${dep.user_details?.email || ''}</small>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td><strong>₦${formatNumber(dep.amount)}</strong></td>
                                                <td>${dep.payment_method}</td>
                                                <td>
                                                    ${dep.has_proof ? `
                                                        <button class="btn btn-sm btn-outline-primary" onclick="viewImage('${dep.proof_url}')">
                                                            <i class="fas fa-image"></i> View
                                                        </button>
                                                    ` : '<span class="text-muted">No proof</span>'}
                                                </td>
                                                <td>${formatDate(dep.createdAt)}</td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-success" onclick="showActionModal('deposit', '${dep._id}', 'approve')">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                        <button class="btn btn-danger" onclick="showActionModal('deposit', '${dep._id}', 'reject')">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                        <button class="btn btn-info" onclick="viewDepositDetails('${dep._id}')">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            ${pendingData.data.count > 5 ? `
                                <div class="text-center mt-2">
                                    <a href="#" class="text-warning view-all-pending" data-type="deposits">
                                        View all ${pendingData.data.count} pending deposits
                                    </a>
                                </div>
                            ` : ''}
                        </div>
                    ` : '<div class="alert alert-success mb-4"><i class="fas fa-check-circle"></i> No pending deposits at the moment.</div>'}
                    
                    <!-- All Deposits -->
                    <div class="data-table-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6>All Deposits</h6>
                            <div class="btn-group">
                                <button class="btn btn-sm ${currentFilter === 'all' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('all')">All</button>
                                <button class="btn btn-sm ${currentFilter === 'pending' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('pending')">Pending</button>
                                <button class="btn btn-sm ${currentFilter === 'approved' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('approved')">Approved</button>
                                <button class="btn btn-sm ${currentFilter === 'rejected' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('rejected')">Rejected</button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover" id="depositsTable">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Amount</th>
                                        <th>Method</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                        <th>Proof</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${allData.data?.deposits?.map(dep => `
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="user-avatar me-2">
                                                        ${dep.user_details?.name?.charAt(0)?.toUpperCase() || 'U'}
                                                    </div>
                                                    <div>
                                                        <strong>${dep.user_details?.name || 'Unknown'}</strong><br>
                                                        <small class="text-muted">${dep.user_details?.email || ''}</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td><strong>₦${formatNumber(dep.amount)}</strong></td>
                                            <td>${dep.payment_method}</td>
                                            <td>
                                                <span class="badge-status badge-${dep.status}">
                                                    ${dep.status}
                                                </span>
                                            </td>
                                            <td>${formatDate(dep.createdAt)}</td>
                                            <td>
                                                ${dep.has_proof ? `
                                                    <button class="btn btn-sm btn-outline-primary" onclick="viewImage('${dep.proof_url}')">
                                                        <i class="fas fa-image"></i>
                                                    </button>
                                                ` : '<span class="text-muted">No proof</span>'}
                                            </td>
                                            <td>
                                                ${dep.status === 'pending' ? `
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-success" onclick="showActionModal('deposit', '${dep._id}', 'approve')">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                        <button class="btn btn-danger" onclick="showActionModal('deposit', '${dep._id}', 'reject')">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                ` : `
                                                    <button class="btn btn-sm btn-outline-primary" onclick="viewDepositDetails('${dep._id}')">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                `}
                                            </td>
                                        </tr>
                                    `).join('') || '<tr><td colspan="7" class="text-center">No deposits found</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        } catch (error) {
            return `
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-triangle"></i> Error loading deposits</h5>
                    <p>${error.message}</p>
                    <button class="btn btn-primary mt-2" onclick="loadDeposits()">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            `;
        }
    }

    // ==================== WITHDRAWALS MANAGEMENT ====================
    async function loadWithdrawals() {
        try {
            let pendingData, allData;
            
            // Load pending withdrawals
            pendingData = await makeRequest(API_ENDPOINTS.adminWithdrawals);
            
            // Load all withdrawals based on filter
            let endpoint = API_ENDPOINTS.adminWithdrawals; // Default to pending
            if (currentFilter === 'paid') endpoint += '?status=paid';
            else if (currentFilter === 'rejected') endpoint += '?status=rejected';
            else if (currentFilter === 'all') {
                endpoint = API_ENDPOINTS.adminWithdrawals;
            }
            
            allData = await makeRequest(endpoint);
            
            return `
                <div class="page-content">
                    <h5 class="mb-4"><i class="fas fa-arrow-up"></i> Withdrawals Management</h5>
                    
                    <!-- Pending Withdrawals -->
                    ${pendingData.data?.withdrawals?.length > 0 ? `
                        <div class="alert alert-warning mb-4">
                            <h6><i class="fas fa-exclamation-triangle"></i> ${pendingData.data.count} Pending Withdrawals Require Approval</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>User</th>
                                            <th>Amount</th>
                                            <th>Method</th>
                                            <th>Net Amount</th>
                                            <th>Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${pendingData.data.withdrawals.slice(0, 5).map(wdl => `
                                            <tr>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="user-avatar me-2">
                                                            ${wdl.user_details?.name?.charAt(0)?.toUpperCase() || 'U'}
                                                        </div>
                                                        <div>
                                                            <strong>${wdl.user_details?.name || 'Unknown'}</strong><br>
                                                            <small class="text-muted">${wdl.user_details?.email || ''}</small>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td><strong>₦${formatNumber(wdl.amount)}</strong></td>
                                                <td>${wdl.payment_method}</td>
                                                <td>₦${formatNumber(wdl.net_amount)}</td>
                                                <td>${formatDate(wdl.createdAt)}</td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-success" onclick="showActionModal('withdrawal', '${wdl._id}', 'approve')">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                        <button class="btn btn-danger" onclick="showActionModal('withdrawal', '${wdl._id}', 'reject')">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                        <button class="btn btn-info" onclick="viewWithdrawalDetails('${wdl._id}')">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            ${pendingData.data.count > 5 ? `
                                <div class="text-center mt-2">
                                    <a href="#" class="text-warning view-all-pending" data-type="withdrawals">
                                        View all ${pendingData.data.count} pending withdrawals
                                    </a>
                                </div>
                            ` : ''}
                        </div>
                    ` : '<div class="alert alert-success mb-4"><i class="fas fa-check-circle"></i> No pending withdrawals at the moment.</div>'}
                    
                    <!-- All Withdrawals -->
                    <div class="data-table-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6>All Withdrawals</h6>
                            <div class="btn-group">
                                <button class="btn btn-sm ${currentFilter === 'all' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('all')">All</button>
                                <button class="btn btn-sm ${currentFilter === 'pending' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('pending')">Pending</button>
                                <button class="btn btn-sm ${currentFilter === 'paid' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('paid')">Paid</button>
                                <button class="btn btn-sm ${currentFilter === 'rejected' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('rejected')">Rejected</button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover" id="withdrawalsTable">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Amount</th>
                                        <th>Method</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${allData.data?.withdrawals?.map(wdl => `
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="user-avatar me-2">
                                                        ${wdl.user_details?.name?.charAt(0)?.toUpperCase() || 'U'}
                                                    </div>
                                                    <div>
                                                        <strong>${wdl.user_details?.name || 'Unknown'}</strong><br>
                                                        <small class="text-muted">${wdl.user_details?.email || ''}</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td><strong>₦${formatNumber(wdl.amount)}</strong></td>
                                            <td>${wdl.payment_method}</td>
                                            <td>
                                                <span class="badge-status badge-${wdl.status}">
                                                    ${wdl.status}
                                                </span>
                                            </td>
                                            <td>${formatDate(wdl.createdAt)}</td>
                                            <td>
                                                ${wdl.status === 'pending' ? `
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-success" onclick="showActionModal('withdrawal', '${wdl._id}', 'approve')">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                        <button class="btn btn-danger" onclick="showActionModal('withdrawal', '${wdl._id}', 'reject')">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                ` : `
                                                    <button class="btn btn-sm btn-outline-primary" onclick="viewWithdrawalDetails('${wdl._id}')">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                `}
                                            </td>
                                        </tr>
                                    `).join('') || '<tr><td colspan="6" class="text-center">No withdrawals found</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        } catch (error) {
            return `
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-triangle"></i> Error loading withdrawals</h5>
                    <p>${error.message}</p>
                    <button class="btn btn-primary mt-2" onclick="loadWithdrawals()">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            `;
        }
    }

    // ==================== TRANSACTIONS ====================
    async function loadTransactions() {
        try {
            const data = await makeRequest(API_ENDPOINTS.adminTransactions);
            
            return `
                <div class="page-content">
                    <h5 class="mb-4"><i class="fas fa-exchange-alt"></i> Transactions History</h5>
                    
                    <!-- Transaction Stats -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stats-card-sm">
                                <div class="number">${data.data?.summary?.total_transactions || 0}</div>
                                <div class="label">Total Transactions</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card-sm">
                                <div class="number">₦${formatNumber(data.data?.summary?.income || 0)}</div>
                                <div class="label">Total Income</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card-sm">
                                <div class="number">₦${formatNumber(data.data?.summary?.expenses || 0)}</div>
                                <div class="label">Total Expenses</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card-sm">
                                <div class="number">₦${formatNumber((data.data?.summary?.income || 0) - (data.data?.summary?.expenses || 0))}</div>
                                <div class="label">Net Flow</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="data-table-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6>All Transactions</h6>
                            <div class="btn-group">
                                <button class="btn btn-sm ${currentFilter === 'all' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('all')">All</button>
                                <button class="btn btn-sm ${currentFilter === 'deposit' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('deposit')">Deposits</button>
                                <button class="btn btn-sm ${currentFilter === 'withdrawal' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('withdrawal')">Withdrawals</button>
                                <button class="btn btn-sm ${currentFilter === 'investment' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('investment')">Investments</button>
                                <button class="btn btn-sm ${currentFilter === 'earning' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('earning')">Earnings</button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover" id="transactionsTable">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Type</th>
                                        <th>Amount</th>
                                        <th>Description</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                        <th>Proof</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.data?.transactions?.map(txn => `
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="user-avatar me-2">
                                                        ${txn.user_name?.charAt(0)?.toUpperCase() || 'U'}
                                                    </div>
                                                    <div>
                                                        <strong>${txn.user_name || 'System'}</strong><br>
                                                        <small class="text-muted">${txn.user_email || ''}</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge bg-${getTransactionTypeColor(txn.type)}">
                                                    ${txn.type}
                                                </span>
                                            </td>
                                            <td class="${txn.amount > 0 ? 'text-success' : 'text-danger'}">
                                                <strong>${txn.amount > 0 ? '+' : ''}₦${formatNumber(Math.abs(txn.amount))}</strong>
                                            </td>
                                            <td>${txn.description}</td>
                                            <td>
                                                <span class="badge-status badge-${txn.status}">
                                                    ${txn.status}
                                                </span>
                                            </td>
                                            <td>${formatDate(txn.createdAt, true)}</td>
                                            <td>
                                                ${txn.has_proof ? `
                                                    <button class="btn btn-sm btn-outline-primary" onclick="viewImage('${txn.proof_url}')">
                                                        <i class="fas fa-image"></i>
                                                    </button>
                                                ` : '<span class="text-muted">No proof</span>'}
                                            </td>
                                        </tr>
                                    `).join('') || '<tr><td colspan="7" class="text-center">No transactions found</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        } catch (error) {
            return `
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-triangle"></i> Error loading transactions</h5>
                    <p>${error.message}</p>
                    <button class="btn btn-primary mt-2" onclick="loadTransactions()">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            `;
        }
    }

    // ==================== KYC VERIFICATION ====================
    async function loadKYC() {
        try {
            const data = await makeRequest(API_ENDPOINTS.adminKYC);
            
            return `
                <div class="page-content">
                    <h5 class="mb-4"><i class="fas fa-id-card"></i> KYC Verification</h5>
                    
                    <!-- Pending KYC -->
                    ${data.data?.kyc_submissions?.length > 0 ? `
                        <div class="alert alert-warning mb-4">
                            <h6><i class="fas fa-exclamation-triangle"></i> ${data.data.count} Pending KYC Submissions</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>User</th>
                                            <th>ID Type</th>
                                            <th>ID Number</th>
                                            <th>Documents</th>
                                            <th>Submitted</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.data.kyc_submissions.slice(0, 5).map(kyc => `
                                            <tr>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="user-avatar me-2">
                                                            ${kyc.user_name?.charAt(0)?.toUpperCase() || 'U'}
                                                        </div>
                                                        <div>
                                                            <strong>${kyc.user_name || 'Unknown'}</strong><br>
                                                            <small class="text-muted">${kyc.user_email || ''}</small>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>${formatIdType(kyc.id_type)}</td>
                                                <td>${kyc.id_number}</td>
                                                <td>
                                                    <div class="image-preview-container">
                                                        ${kyc.images?.id_front ? `<img src="${kyc.images.id_front}" class="image-preview" alt="ID Front" style="width: 60px; height: 60px;">` : ''}
                                                        ${kyc.images?.selfie ? `<img src="${kyc.images.selfie}" class="image-preview" alt="Selfie" style="width: 60px; height: 60px;">` : ''}
                                                    </div>
                                                </td>
                                                <td>${formatDate(kyc.createdAt)}</td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-success" onclick="showActionModal('kyc', '${kyc._id}', 'approve')">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                        <button class="btn btn-danger" onclick="showActionModal('kyc', '${kyc._id}', 'reject')">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                        <button class="btn btn-info" onclick="viewKYCDetails('${kyc._id}')">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            ${data.data.count > 5 ? `
                                <div class="text-center mt-2">
                                    <a href="#" class="text-warning view-all-pending" data-type="kyc">
                                        View all ${data.data.count} pending KYC
                                    </a>
                                </div>
                            ` : ''}
                        </div>
                    ` : '<div class="alert alert-success mb-4"><i class="fas fa-check-circle"></i> No pending KYC submissions at the moment.</div>'}
                    
                    <!-- KYC Statistics -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stats-card-sm">
                                <div class="number">${data.data?.summary?.complete_submissions || 0}</div>
                                <div class="label">Complete Submissions</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card-sm">
                                <div class="number">${data.data?.summary?.incomplete_submissions || 0}</div>
                                <div class="label">Incomplete</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card-sm">
                                <div class="number">${data.data?.summary?.with_address_proof || 0}</div>
                                <div class="label">With Address Proof</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card-sm">
                                <div class="number">${data.data?.count || 0}</div>
                                <div class="label">Total Pending</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- KYC Search -->
                    <div class="data-table-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6>KYC Submissions</h6>
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" class="form-control" placeholder="Search by name or ID..." id="kycSearch">
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover" id="kycTable">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>ID Type</th>
                                        <th>ID Number</th>
                                        <th>Status</th>
                                        <th>Submitted</th>
                                        <th>Verified</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.data?.kyc_submissions?.map(kyc => `
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="user-avatar me-2">
                                                        ${kyc.user_name?.charAt(0)?.toUpperCase() || 'U'}
                                                    </div>
                                                    <div>
                                                        <strong>${kyc.user_name || 'Unknown'}</strong><br>
                                                        <small class="text-muted">${kyc.user_email || ''}</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>${formatIdType(kyc.id_type)}</td>
                                            <td>${kyc.id_number}</td>
                                            <td>
                                                <span class="badge-status badge-${kyc.status}">
                                                    ${kyc.status}
                                                </span>
                                            </td>
                                            <td>${formatDate(kyc.createdAt)}</td>
                                            <td>${kyc.reviewed_at ? formatDate(kyc.reviewed_at, true) : 'Not verified'}</td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    ${kyc.status === 'pending' ? `
                                                        <button class="btn btn-success" onclick="showActionModal('kyc', '${kyc._id}', 'approve')">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                        <button class="btn btn-danger" onclick="showActionModal('kyc', '${kyc._id}', 'reject')">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    ` : ''}
                                                    <button class="btn btn-info" onclick="viewKYCDetails('${kyc._id}')">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('') || '<tr><td colspan="7" class="text-center">No KYC submissions found</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        } catch (error) {
            return `
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-triangle"></i> Error loading KYC</h5>
                    <p>${error.message}</p>
                    <button class="btn btn-primary mt-2" onclick="loadKYC()">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            `;
        }
    }

    // ==================== INVESTMENT PLANS ====================
    async function loadPlans() {
        try {
            const data = await makeRequest(API_ENDPOINTS.investmentPlans);
            
            return `
                <div class="page-content">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5><i class="fas fa-boxes"></i> Investment Plans</h5>
                        <button class="btn btn-primary" onclick="createNewPlan()">
                            <i class="fas fa-plus"></i> Create New Plan
                        </button>
                    </div>
                    
                    <div class="row">
                        ${data.data?.plans?.map(plan => `
                            <div class="col-md-4 mb-4">
                                <div class="card dashboard-card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                            <h5 class="card-title mb-0">${plan.name}</h5>
                                            <span class="badge bg-${plan.is_active ? 'success' : 'danger'}">
                                                ${plan.is_active ? 'Active' : 'Inactive'}
                                            </span>
                                        </div>
                                        
                                        <p class="card-text text-muted">${plan.description}</p>
                                        
                                        <div class="row mb-3">
                                            <div class="col-6">
                                                <small class="text-muted">Min Investment</small>
                                                <h6>₦${formatNumber(plan.min_amount)}</h6>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted">Daily Interest</small>
                                                <h6>${plan.daily_interest}%</h6>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted">Duration</small>
                                                <h6>${plan.duration} days</h6>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted">Total Interest</small>
                                                <h6>${plan.total_interest}%</h6>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <small class="text-muted">Features:</small>
                                            <div>
                                                ${(plan.features || ['Secure Investment', 'Daily Payouts', '24/7 Support']).map(feature => `
                                                    <span class="badge bg-light text-dark me-1 mb-1">${feature}</span>
                                                `).join('')}
                                            </div>
                                        </div>
                                        
                                        <div class="d-flex justify-content-between">
                                            <small class="text-muted">
                                                <i class="fas fa-chart-line"></i> ${plan.investment_count || 0} investments
                                            </small>
                                            <small class="text-muted">
                                                <i class="fas fa-money-bill"></i> ₦${formatNumber(plan.total_invested || 0)}
                                            </small>
                                        </div>
                                    </div>
                                    <div class="card-footer bg-transparent">
                                        <div class="btn-group w-100">
                                            <button class="btn btn-sm btn-outline-primary" onclick="editPlan('${plan._id}')">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                            <button class="btn btn-sm btn-outline-${plan.is_active ? 'danger' : 'success'}" onclick="togglePlanStatus('${plan._id}', ${!plan.is_active})">
                                                ${plan.is_active ? '<i class="fas fa-ban"></i> Deactivate' : '<i class="fas fa-check"></i> Activate'}
                                            </button>
                                            <button class="btn btn-sm btn-outline-info" onclick="viewPlanStats('${plan._id}')">
                                                <i class="fas fa-chart-bar"></i> Stats
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        } catch (error) {
            return `
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-triangle"></i> Error loading plans</h5>
                    <p>${error.message}</p>
                    <button class="btn btn-primary mt-2" onclick="loadPlans()">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            `;
        }
    }

    // ==================== SUPPORT TICKETS ====================
    async function loadSupportTickets() {
        try {
            const data = await makeRequest(API_ENDPOINTS.supportTickets);
            
            return `
                <div class="page-content">
                    <h5 class="mb-4"><i class="fas fa-headset"></i> Support Tickets</h5>
                    
                    <div class="data-table-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6>All Tickets</h6>
                            <div class="btn-group">
                                <button class="btn btn-sm ${currentFilter === 'all' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('all')">All</button>
                                <button class="btn btn-sm ${currentFilter === 'open' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('open')">Open</button>
                                <button class="btn btn-sm ${currentFilter === 'in_progress' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('in_progress')">In Progress</button>
                                <button class="btn btn-sm ${currentFilter === 'resolved' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('resolved')">Resolved</button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover" id="supportTicketsTable">
                                <thead>
                                    <tr>
                                        <th>Ticket ID</th>
                                        <th>User</th>
                                        <th>Subject</th>
                                        <th>Category</th>
                                        <th>Priority</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.data?.tickets?.map(ticket => `
                                        <tr>
                                            <td><strong>${ticket.ticket_id}</strong></td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="user-avatar me-2">
                                                        ${ticket.user?.full_name?.charAt(0)?.toUpperCase() || 'U'}
                                                    </div>
                                                    <div>
                                                        <strong>${ticket.user?.full_name || 'Unknown'}</strong><br>
                                                        <small class="text-muted">${ticket.user?.email || ''}</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>${ticket.subject}</td>
                                            <td>
                                                <span class="badge bg-secondary">${ticket.category}</span>
                                            </td>
                                            <td>
                                                <span class="badge bg-${getPriorityColor(ticket.priority)}">
                                                    ${ticket.priority}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge-status badge-${ticket.status}">
                                                    ${ticket.status}
                                                </span>
                                            </td>
                                            <td>${formatDate(ticket.createdAt)}</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary" onclick="viewSupportTicket('${ticket._id}')">
                                                    <i class="fas fa-eye"></i> View
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('') || '<tr><td colspan="8" class="text-center">No support tickets found</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        } catch (error) {
            return `
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-triangle"></i> Error loading support tickets</h5>
                    <p>${error.message}</p>
                    <button class="btn btn-primary mt-2" onclick="loadSupportTickets()">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            `;
        }
    }

    // ==================== REFERRALS ====================
    async function loadReferrals() {
        try {
            const data = await makeRequest(API_ENDPOINTS.referralsStats);
            
            return `
                <div class="page-content">
                    <h5 class="mb-4"><i class="fas fa-user-friends"></i> Referrals System</h5>
                    
                    <!-- Referral Stats -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stats-card-sm">
                                <div class="number">${data.data?.stats?.total_referrals || 0}</div>
                                <div class="label">Total Referrals</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card-sm">
                                <div class="number">${data.data?.stats?.active_referrals || 0}</div>
                                <div class="label">Active Referrals</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card-sm">
                                <div class="number">₦${formatNumber(data.data?.stats?.total_earnings || 0)}</div>
                                <div class="label">Total Earnings</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card-sm">
                                <div class="number">₦${formatNumber(data.data?.stats?.pending_earnings || 0)}</div>
                                <div class="label">Pending Earnings</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Referral Link -->
                    <div class="alert alert-info mb-4">
                        <h6><i class="fas fa-link"></i> Platform Referral Link</h6>
                        <p>Share this link to refer new users:</p>
                        <div class="input-group">
                            <input type="text" class="form-control" value="${data.data?.stats?.referral_link || `${API_BASE_URL}/register`}" readonly>
                            <button class="btn btn-primary" onclick="copyToClipboard('${data.data?.stats?.referral_link || `${API_BASE_URL}/register`}')">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                    </div>
                    
                    <!-- All Referrals -->
                    <div class="data-table-container">
                        <h6>Recent Referrals</h6>
                        <div class="table-responsive">
                            <table class="table table-hover" id="referralsTable">
                                <thead>
                                    <tr>
                                        <th>Referrer</th>
                                        <th>Referred User</th>
                                        <th>Status</th>
                                        <th>Earnings</th>
                                        <th>Date</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.data?.referrals?.map(ref => `
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="user-avatar me-2">
                                                        ${ref.referrer?.full_name?.charAt(0)?.toUpperCase() || 'R'}
                                                    </div>
                                                    <div>
                                                        <strong>${ref.referrer?.full_name || 'Unknown'}</strong><br>
                                                        <small class="text-muted">${ref.referrer?.email || ''}</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="user-avatar me-2">
                                                        ${ref.referred_user?.full_name?.charAt(0)?.toUpperCase() || 'U'}
                                                    </div>
                                                    <div>
                                                        <strong>${ref.referred_user?.full_name || 'Unknown'}</strong><br>
                                                        <small class="text-muted">${ref.referred_user?.email || ''}</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge-status badge-${ref.status}">
                                                    ${ref.status}
                                                </span>
                                            </td>
                                            <td>₦${formatNumber(ref.earnings || 0)}</td>
                                            <td>${formatDate(ref.createdAt)}</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary" onclick="viewReferralDetails('${ref._id}')">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('') || '<tr><td colspan="6" class="text-center">No referrals found</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        } catch (error) {
            return `
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-triangle"></i> Error loading referrals</h5>
                    <p>${error.message}</p>
                    <button class="btn btn-primary mt-2" onclick="loadReferrals()">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            `;
        }
    }

    // ==================== NOTIFICATIONS ====================
    async function loadNotifications() {
        try {
            const data = await makeRequest(API_ENDPOINTS.notifications);
            
            return `
                <div class="page-content">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5><i class="fas fa-bell"></i> Notifications</h5>
                        <div>
                            <button class="btn btn-primary me-2" onclick="markAllNotificationsRead()">
                                <i class="fas fa-check-double"></i> Mark All Read
                            </button>
                            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#sendNotificationModal">
                                <i class="fas fa-paper-plane"></i> Send Notification
                            </button>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="data-table-container">
                                <h6>All Notifications</h6>
                                <div id="notificationsList">
                                    ${data.data?.notifications?.map(notif => `
                                        <div class="card mb-2 ${notif.is_read ? 'bg-light' : 'bg-white border-primary'}">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div>
                                                        <h6 class="card-title mb-1 ${notif.is_read ? 'text-muted' : 'text-dark'}">
                                                            ${notif.is_read ? '' : '<i class="fas fa-circle text-primary me-1" style="font-size: 8px;"></i>'}
                                                            ${notif.title}
                                                        </h6>
                                                        <p class="card-text mb-1">${notif.message}</p>
                                                        <small class="text-muted">
                                                            <i class="fas fa-clock"></i> ${getTimeAgo(notif.createdAt)}
                                                            ${notif.type ? ` • <span class="badge bg-${getNotificationTypeColor(notif.type)}">${notif.type}</span>` : ''}
                                                        </small>
                                                    </div>
                                                    <div>
                                                        ${!notif.is_read ? `
                                                            <button class="btn btn-sm btn-outline-primary" onclick="markNotificationRead('${notif._id}')" title="Mark as read">
                                                                <i class="fas fa-check"></i>
                                                            </button>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('') || '<p class="text-center text-muted">No notifications</p>'}
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-4">
                            <div class="data-table-container">
                                <h6>Send Quick Notification</h6>
                                <form id="quickNotificationForm">
                                    <div class="mb-3">
                                        <label class="form-label">Type</label>
                                        <select class="form-select" id="quickType">
                                            <option value="info">Information</option>
                                            <option value="success">Success</option>
                                            <option value="warning">Warning</option>
                                            <option value="promotional">Promotional</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Message</label>
                                        <textarea class="form-control" id="quickMessage" rows="4" placeholder="Enter your message..."></textarea>
                                    </div>
                                    <div class="d-grid">
                                        <button type="button" class="btn btn-primary" onclick="sendQuickNotification()">
                                            <i class="fas fa-paper-plane"></i> Send to All Users
                                        </button>
                                    </div>
                                </form>
                            </div>
                            
                            <div class="data-table-container mt-4">
                                <h6>Notification Stats</h6>
                                <div class="list-group">
                                    <div class="list-group-item d-flex justify-content-between">
                                        <span>Total Notifications</span>
                                        <strong>${data.data?.summary?.total || 0}</strong>
                                    </div>
                                    <div class="list-group-item d-flex justify-content-between">
                                        <span>Unread</span>
                                        <strong>${data.data?.unread_count || 0}</strong>
                                    </div>
                                    <div class="list-group-item d-flex justify-content-between">
                                        <span>Sent Today</span>
                                        <strong>${data.data?.summary?.by_type?.today || 0}</strong>
                                    </div>
                                    <div class="list-group-item d-flex justify-content-between">
                                        <span>Sent This Week</span>
                                        <strong>${data.data?.summary?.by_type?.week || 0}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } catch (error) {
            return `
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-triangle"></i> Error loading notifications</h5>
                    <p>${error.message}</p>
                    <button class="btn btn-primary mt-2" onclick="loadNotifications()">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            `;
        }
    }

    // ==================== AUDIT LOGS ====================
    async function loadAuditLogs() {
        // Since this endpoint might not exist, show placeholder
        return `
            <div class="page-content">
                <h5 class="mb-4"><i class="fas fa-clipboard-list"></i> Audit Logs</h5>
                
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle"></i> Audit Logs Feature</h6>
                    <p>The audit logs feature is fully implemented in the backend but requires the audit logs endpoint to be enabled.</p>
                    <p>Backend endpoint: <code>/api/admin/audit-logs</code></p>
                </div>
                
                <div class="data-table-container">
                    <h6>Recent Admin Activities</h6>
                    <div class="table-responsive">
                        <table class="table table-hover" id="auditLogsTable">
                            <thead>
                                <tr>
                                    <th>Admin</th>
                                    <th>Action</th>
                                    <th>Target</th>
                                    <th>Details</th>
                                    <th>Timestamp</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="5" class="text-center text-muted">
                                        <i class="fas fa-info-circle"></i> Audit logs will appear here when the endpoint is enabled
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    }

    // ==================== SETTINGS ====================
    async function loadSettings() {
        return `
            <div class="page-content">
                <h5 class="mb-4"><i class="fas fa-cogs"></i> System Settings</h5>
                
                <div class="row">
                    <div class="col-lg-6">
                        <div class="data-table-container mb-4">
                            <h6><i class="fas fa-sliders-h"></i> Platform Settings</h6>
                            <form id="platformSettingsForm">
                                <div class="mb-3">
                                    <label class="form-label">Platform Name</label>
                                    <input type="text" class="form-control" value="Raw Wealthy" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Platform Fee (%)</label>
                                    <input type="number" class="form-control" id="platformFee" value="10" min="0" max="100" step="0.1">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Referral Commission (%)</label>
                                    <input type="number" class="form-control" id="referralCommission" value="10" min="0" max="100" step="0.1">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Welcome Bonus (₦)</label>
                                    <input type="number" class="form-control" id="welcomeBonus" value="100" min="0">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Minimum Deposit (₦)</label>
                                    <input type="number" class="form-control" id="minDeposit" value="3500" min="0">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Minimum Withdrawal (₦)</label>
                                    <input type="number" class="form-control" id="minWithdrawal" value="3500" min="0">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Minimum Investment (₦)</label>
                                    <input type="number" class="form-control" id="minInvestment" value="3500" min="0">
                                </div>
                                <button type="button" class="btn btn-primary" onclick="updatePlatformSettings()">
                                    <i class="fas fa-save"></i> Save Settings
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <div class="col-lg-6">
                        <div class="data-table-container mb-4">
                            <h6><i class="fas fa-envelope"></i> Email Settings</h6>
                            <form id="emailSettingsForm">
                                <div class="mb-3">
                                    <label class="form-label">SMTP Host</label>
                                    <input type="text" class="form-control" id="smtpHost" placeholder="smtp.gmail.com">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">SMTP Port</label>
                                    <input type="number" class="form-control" id="smtpPort" value="587">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">SMTP Username</label>
                                    <input type="email" class="form-control" id="smtpUsername" placeholder="your-email@gmail.com">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">SMTP Password</label>
                                    <input type="password" class="form-control" id="smtpPassword" placeholder="Your SMTP password">
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="emailEnabled" checked>
                                    <label class="form-check-label" for="emailEnabled">
                                        Enable Email Notifications
                                    </label>
                                </div>
                                <button type="button" class="btn btn-primary me-2" onclick="updateEmailSettings()">
                                    <i class="fas fa-save"></i> Save Email Settings
                                </button>
                                <button type="button" class="btn btn-info" onclick="testEmailSettings()">
                                    <i class="fas fa-paper-plane"></i> Test Email
                                </button>
                            </form>
                        </div>
                        
                        <div class="data-table-container">
                            <h6><i class="fas fa-info-circle"></i> System Information</h6>
                            <div class="list-group">
                                <div class="list-group-item d-flex justify-content-between">
                                    <span>Backend Version</span>
                                    <strong>v37.0.0</strong>
                                </div>
                                <div class="list-group-item d-flex justify-content-between">
                                    <span>Dashboard Version</span>
                                    <strong>v1.0.0</strong>
                                </div>
                                <div class="list-group-item d-flex justify-content-between">
                                    <span>API Status</span>
                                    <span class="badge bg-success">Online</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between">
                                    <span>Database</span>
                                    <span class="badge bg-success">Connected</span>
                                </div>
                                <div class="list-group-item">
                                    <button class="btn btn-sm btn-outline-primary w-100" onclick="checkSystemHealth()">
                                        <i class="fas fa-heartbeat"></i> Check System Health
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // ==================== ACTION FUNCTIONS ====================
    async function viewUserDetails(userId) {
        try {
            const data = await makeRequest(API_ENDPOINTS.adminUserDetails(userId));
            
            if (!data.success) throw new Error(data.message);
            
            const user = data.data.user;
            const stats = data.data.statistics || {};
            
            $('#userDetailsContent').html(`
                <div class="row">
                    <div class="col-md-4">
                        <div class="card dashboard-card mb-3">
                            <div class="card-body text-center">
                                <div class="user-avatar mx-auto mb-3" style="width: 80px; height: 80px; font-size: 2rem;">
                                    ${user.full_name ? user.full_name.charAt(0).toUpperCase() : 'U'}
                                </div>
                                <h5>${user.full_name || 'Unknown'}</h5>
                                <p class="text-muted">${user.email}</p>
                                <div class="d-flex justify-content-center">
                                    <span class="badge bg-${user.is_active ? 'success' : 'danger'} me-2">
                                        ${user.is_active ? 'Active' : 'Inactive'}
                                    </span>
                                    <span class="badge bg-info">
                                        ${user.role}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card dashboard-card">
                            <div class="card-body">
                                <h6>Account Information</h6>
                                <table class="table table-sm">
                                    <tr>
                                        <td><strong>Phone:</strong></td>
                                        <td>${user.phone || 'N/A'}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Country:</strong></td>
                                        <td>${user.country || 'N/A'}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Currency:</strong></td>
                                        <td>${user.currency || 'NGN'}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Referral Code:</strong></td>
                                        <td>${user.referral_code || 'N/A'}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Joined:</strong></td>
                                        <td>${formatDate(user.createdAt)}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Last Login:</strong></td>
                                        <td>${user.last_login ? formatDate(user.last_login, true) : 'Never'}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-8">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="stats-card-sm">
                                    <div class="number">₦${formatNumber(user.balance || 0)}</div>
                                    <div class="label">Current Balance</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="stats-card-sm">
                                    <div class="number">₦${formatNumber(stats.portfolio_value || 0)}</div>
                                    <div class="label">Portfolio Value</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="stats-card-sm">
                                    <div class="number">₦${formatNumber(stats.total_earned || 0)}</div>
                                    <div class="label">Total Earnings</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="stats-card-sm">
                                    <div class="number">₦${formatNumber(stats.daily_interest || 0)}</div>
                                    <div class="label">Daily Interest</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card dashboard-card mb-3">
                            <div class="card-body">
                                <h6>Bank Details</h6>
                                ${user.bank_details ? `
                                    <table class="table table-sm">
                                        <tr>
                                            <td><strong>Bank Name:</strong></td>
                                            <td>${user.bank_details.bank_name || 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Account Name:</strong></td>
                                            <td>${user.bank_details.account_name || 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Account Number:</strong></td>
                                            <td>${user.bank_details.account_number || 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Verified:</strong></td>
                                            <td>
                                                <span class="badge ${user.bank_details.verified ? 'bg-success' : 'bg-warning'}">
                                                    ${user.bank_details.verified ? 'Verified' : 'Not Verified'}
                                                </span>
                                            </td>
                                        </tr>
                                    </table>
                                ` : '<p class="text-muted">No bank details provided</p>'}
                            </div>
                        </div>
                        
                        <div class="card dashboard-card">
                            <div class="card-body">
                                <h6>Quick Actions</h6>
                                <div class="btn-group w-100">
                                    <button class="btn btn-primary" onclick="updateUserBalanceModal('${user._id}', '${user.full_name || user.email}', ${user.balance || 0})">
                                        <i class="fas fa-coins"></i> Update Balance
                                    </button>
                                    <button class="btn btn-${user.is_active ? 'danger' : 'success'}" onclick="toggleUserStatus('${user._id}', ${!user.is_active})">
                                        ${user.is_active ? '<i class="fas fa-ban"></i> Deactivate' : '<i class="fas fa-check"></i> Activate'}
                                    </button>
                                    <button class="btn btn-info" onclick="changeUserRole('${user._id}')">
                                        <i class="fas fa-user-tag"></i> Change Role
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `);
            
            $('#userDetailsModal').modal('show');
        } catch (error) {
            toastr.error('Error loading user details: ' + error.message);
        }
    }

    async function viewUserDashboard(userId) {
        try {
            const data = await makeRequest(API_ENDPOINTS.adminUserDashboard(userId));
            
            if (!data.success) throw new Error(data.message);
            
            const user = data.data.user;
            const stats = data.data.dashboard_stats || {};
            
            $('#userDetailsContent').html(`
                <div class="row">
                    <div class="col-md-12">
                        <h4><i class="fas fa-tachometer-alt"></i> User Dashboard: ${user.full_name}</h4>
                        <hr>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3">
                        <div class="stats-card-sm">
                            <div class="number">₦${formatNumber(stats.current_balance || 0)}</div>
                            <div class="label">Current Balance</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card-sm">
                            <div class="number">₦${formatNumber(stats.portfolio_value || 0)}</div>
                            <div class="label">Portfolio Value</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card-sm">
                            <div class="number">₦${formatNumber(stats.total_earnings || 0)}</div>
                            <div class="label">Total Earnings</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card-sm">
                            <div class="number">${stats.active_investments_count || 0}</div>
                            <div class="label">Active Investments</div>
                        </div>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card dashboard-card">
                            <div class="card-body">
                                <h6>Recent Investments</h6>
                                ${data.data.investment_history?.length > 0 ? `
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Plan</th>
                                                    <th>Amount</th>
                                                    <th>Status</th>
                                                    <th>Date</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${data.data.investment_history.slice(0, 5).map(inv => `
                                                    <tr>
                                                        <td>${inv.plan?.name || 'N/A'}</td>
                                                        <td>₦${formatNumber(inv.amount)}</td>
                                                        <td><span class="badge bg-${inv.status === 'active' ? 'success' : 'warning'}">${inv.status}</span></td>
                                                        <td>${formatDate(inv.createdAt)}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                ` : '<p class="text-muted">No investments</p>'}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card dashboard-card">
                            <div class="card-body">
                                <h6>Recent Transactions</h6>
                                ${data.data.transaction_history?.length > 0 ? `
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Type</th>
                                                    <th>Amount</th>
                                                    <th>Date</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${data.data.transaction_history.slice(0, 5).map(txn => `
                                                    <tr>
                                                        <td><span class="badge bg-secondary">${txn.type}</span></td>
                                                        <td class="${txn.amount > 0 ? 'text-success' : 'text-danger'}">
                                                            ${txn.amount > 0 ? '+' : ''}₦${formatNumber(Math.abs(txn.amount))}
                                                        </td>
                                                        <td>${formatDate(txn.createdAt)}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                ` : '<p class="text-muted">No transactions</p>'}
                            </div>
                        </div>
                    </div>
                </div>
            `);
            
            $('#userDetailsModal').modal('show');
        } catch (error) {
            toastr.error('Error loading user dashboard: ' + error.message);
        }
    }

    function showActionModal(type, id, action) {
        const actionMap = {
            investment: 'Investment',
            deposit: 'Deposit',
            withdrawal: 'Withdrawal',
            kyc: 'KYC'
        };
        
        const actionText = action === 'approve' ? 'Approve' : 'Reject';
        $('#actionModalTitle').text(`${actionText} ${actionMap[type]}`);
        
        $('#actionModalContent').html(`
            <div class="alert alert-${action === 'approve' ? 'success' : 'warning'}">
                <i class="fas fa-${action === 'approve' ? 'check-circle' : 'exclamation-triangle'}"></i>
                Are you sure you want to ${action} this ${type}?
            </div>
            <p><strong>ID:</strong> ${id}</p>
        `);
        
        $('#actionModal').data('type', type);
        $('#actionModal').data('id', id);
        $('#actionModal').data('action', action);
        $('#actionRemarks').val('');
        
        $('#actionModal').modal('show');
    }

    async function performApproveAction() {
        const type = $('#actionModal').data('type');
        const id = $('#actionModal').data('id');
        const remarks = $('#actionRemarks').val();
        
        let endpoint = '';
        switch(type) {
            case 'investment':
                endpoint = API_ENDPOINTS.approveInvestment(id);
                break;
            case 'deposit':
                endpoint = API_ENDPOINTS.approveDeposit(id);
                break;
            case 'withdrawal':
                endpoint = API_ENDPOINTS.approveWithdrawal(id);
                break;
            case 'kyc':
                endpoint = API_ENDPOINTS.approveKYC(id);
                break;
        }
        
        try {
            const data = await makeRequest(endpoint, 'POST', { remarks });
            
            if (data.success) {
                toastr.success(`${type.charAt(0).toUpperCase() + type.slice(1)} approved successfully`);
                $('#actionModal').modal('hide');
                loadPage(currentPage);
            } else {
                toastr.error(data.message);
            }
        } catch (error) {
            toastr.error('Error performing action: ' + error.message);
        }
    }

    async function performRejectAction() {
        const type = $('#actionModal').data('type');
        const id = $('#actionModal').data('id');
        const remarks = $('#actionRemarks').val();
        
        if (!remarks) {
            toastr.warning('Please provide rejection remarks');
            return;
        }
        
        let endpoint = '';
        switch(type) {
            case 'investment':
                endpoint = API_ENDPOINTS.rejectInvestment(id);
                break;
            case 'deposit':
                endpoint = API_ENDPOINTS.rejectDeposit(id);
                break;
            case 'withdrawal':
                endpoint = API_ENDPOINTS.rejectWithdrawal(id);
                break;
            case 'kyc':
                endpoint = API_ENDPOINTS.rejectKYC(id);
                break;
        }
        
        try {
            const data = await makeRequest(endpoint, 'POST', { remarks, rejection_reason: remarks });
            
            if (data.success) {
                toastr.success(`${type.charAt(0).toUpperCase() + type.slice(1)} rejected successfully`);
                $('#actionModal').modal('hide');
                loadPage(currentPage);
            } else {
                toastr.error(data.message);
            }
        } catch (error) {
            toastr.error('Error performing action: ' + error.message);
        }
    }

    function updateUserBalanceModal(userId, userName, currentBalance) {
        $('#balanceUserId').val(userId);
        $('#balanceUserName').val(userName);
        $('#currentBalance').val(`₦${formatNumber(currentBalance)}`);
        $('#balanceAmount').val('');
        $('#balanceDescription').val('');
        
        $('#updateBalanceModal').modal('show');
    }

    async function updateUserBalance() {
        const userId = $('#balanceUserId').val();
        const action = $('#balanceAction').val();
        const amount = parseFloat($('#balanceAmount').val());
        const description = $('#balanceDescription').val();
        
        if (!amount || amount <= 0) {
            toastr.warning('Please enter a valid amount');
            return;
        }
        
        if (!description) {
            toastr.warning('Please enter a description');
            return;
        }
        
        try {
            const data = await makeRequest(API_ENDPOINTS.updateUserBalance(userId), 'PUT', {
                amount,
                type: action,
                description
            });
            
            if (data.success) {
                toastr.success('Balance updated successfully');
                $('#updateBalanceModal').modal('hide');
                loadPage(currentPage);
            } else {
                toastr.error(data.message);
            }
        } catch (error) {
            toastr.error('Error updating balance: ' + error.message);
        }
    }

    async function toggleUserStatus(userId, activate) {
        try {
            const data = await makeRequest(API_ENDPOINTS.updateUserStatus(userId), 'PUT', {
                is_active: activate
            });
            
            if (data.success) {
                toastr.success(`User ${activate ? 'activated' : 'deactivated'} successfully`);
                loadPage(currentPage);
            } else {
                toastr.error(data.message);
            }
        } catch (error) {
            toastr.error('Error updating user status: ' + error.message);
        }
    }

    async function changeUserRole(userId) {
        const newRole = prompt('Enter new role (user/admin/super_admin):');
        if (newRole && ['user', 'admin', 'super_admin'].includes(newRole.toLowerCase())) {
            try {
                const data = await makeRequest(API_ENDPOINTS.updateUserRole(userId), 'PUT', {
                    role: newRole.toLowerCase()
                });
                
                if (data.success) {
                    toastr.success('User role updated successfully');
                    loadPage(currentPage);
                } else {
                    toastr.error(data.message);
                }
            } catch (error) {
                toastr.error('Error updating user role: ' + error.message);
            }
        } else {
            toastr.warning('Invalid role. Please enter: user, admin, or super_admin');
        }
    }

    async function verifyBankDetails(userId, verify) {
        try {
            const data = await makeRequest(API_ENDPOINTS.verifyBank(userId), 'POST', {
                verified: verify
            });
            
            if (data.success) {
                toastr.success(`Bank details ${verify ? 'verified' : 'unverified'} successfully`);
                loadPage(currentPage);
            } else {
                toastr.error(data.message);
            }
        } catch (error) {
            toastr.error('Error verifying bank details: ' + error.message);
        }
    }

    async function sendNotification() {
        const title = $('#notificationTitle').val();
        const message = $('#notificationMessage').val();
        const type = $('#notificationType').val();
        const target = $('#notificationTarget').val();
        const userId = target === 'specific' ? $('#specificUserId').val() : null;
        
        if (!title || !message) {
            toastr.warning('Please fill in all required fields');
            return;
        }
        
        try {
            const data = await makeRequest(API_ENDPOINTS.sendNotification, 'POST', {
                user_id: userId,
                title,
                message,
                type
            });
            
            if (data.success) {
                toastr.success('Notification sent successfully');
                $('#sendNotificationModal').modal('hide');
                $('#notificationForm')[0].reset();
                $('#specificUserField').hide();
                loadPage('notifications');
            } else {
                toastr.error(data.message);
            }
        } catch (error) {
            toastr.error('Error sending notification: ' + error.message);
        }
    }

    async function sendQuickNotification() {
        const message = $('#quickMessage').val();
        const type = $('#quickType').val();
        
        if (!message) {
            toastr.warning('Please enter a message');
            return;
        }
        
        try {
            const data = await makeRequest(API_ENDPOINTS.sendNotification, 'POST', {
                title: 'Admin Notification',
                message,
                type
            });
            
            if (data.success) {
                toastr.success('Quick notification sent to all users');
                $('#quickMessage').val('');
                loadPage('notifications');
            } else {
                toastr.error(data.message);
            }
        } catch (error) {
            toastr.error('Error sending notification: ' + error.message);
        }
    }

    async function markNotificationRead(notificationId) {
        try {
            const data = await makeRequest(API_ENDPOINTS.markNotificationRead(notificationId), 'POST');
            
            if (data.success) {
                toastr.success('Notification marked as read');
                loadPage('notifications');
            }
        } catch (error) {
            toastr.error('Error marking notification as read');
        }
    }

    async function markAllNotificationsRead() {
        try {
            const data = await makeRequest(API_ENDPOINTS.markAllNotificationsRead, 'POST');
            
            if (data.success) {
                toastr.success('All notifications marked as read');
                loadPage('notifications');
            }
        } catch (error) {
            toastr.error('Error marking notifications as read');
        }
    }

    // ==================== UTILITY FUNCTIONS ====================
    function formatNumber(num) {
        if (!num && num !== 0) return '0';
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    function formatDate(dateString, includeTime = false) {
        if (!dateString) return 'N/A';
        try {
            const date = new Date(dateString);
            
            if (includeTime) {
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        } catch (error) {
            return 'Invalid Date';
        }
    }

    function formatIdType(idType) {
        const types = {
            'national_id': 'National ID',
            'passport': 'Passport',
            'driver_license': 'Driver License',
            'voters_card': 'Voter\'s Card'
        };
        return types[idType] || idType;
    }

    function getTransactionTypeColor(type) {
        const colors = {
            'deposit': 'success',
            'withdrawal': 'warning',
            'investment': 'info',
            'earning': 'success',
            'referral': 'primary',
            'bonus': 'info',
            'fee': 'danger',
            'refund': 'secondary',
            'transfer': 'dark'
        };
        return colors[type] || 'secondary';
    }

    function getPriorityColor(priority) {
        const colors = {
            'low': 'success',
            'medium': 'warning',
            'high': 'danger',
            'urgent': 'danger'
        };
        return colors[priority] || 'secondary';
    }

    function getNotificationTypeColor(type) {
        const colors = {
            'info': 'info',
            'success': 'success',
            'warning': 'warning',
            'error': 'danger',
            'promotional': 'primary',
            'investment': 'info',
            'withdrawal': 'warning',
            'deposit': 'success',
            'kyc': 'secondary',
            'referral': 'primary',
            'system': 'dark'
        };
        return colors[type] || 'secondary';
    }

    function getTimeAgo(dateString) {
        if (!dateString) return 'Just now';
        
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays < 7) return `${diffDays}d ago`;
        return formatDate(dateString);
    }

    function setFilter(filter) {
        currentFilter = filter;
        loadPage(currentPage);
    }

    function filterCurrentPage(searchTerm) {
        if (dataTables[currentPage + 'Table']) {
            dataTables[currentPage + 'Table'].search(searchTerm).draw();
        }
    }

    function viewImage(url) {
        if (!url) {
            toastr.warning('No image available');
            return;
        }
        $('#previewImage').attr('src', url);
        $('#imagePreviewModal').modal('show');
    }

    function updateNotificationCount(pendingActions) {
        if (pendingActions) {
            const total = pendingActions.total_pending || 
                         (pendingActions.pending_investments || 0) + 
                         (pendingActions.pending_deposits || 0) + 
                         (pendingActions.pending_withdrawals || 0) + 
                         (pendingActions.pending_kyc || 0);
            
            $('#notificationCount').text(total > 99 ? '99+' : total);
            $('#notificationCount').toggle(total > 0);
        }
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            toastr.success('Copied to clipboard!');
        }).catch(err => {
            toastr.error('Failed to copy: ' + err);
        });
    }

    function exportData(type) {
        toastr.info(`Export ${type} feature will be available soon`);
        // Implement CSV/Excel export logic here
    }

    function refreshData() {
        loadPage(currentPage);
    }

    function viewInvestmentDetails(id) {
        toastr.info('View investment details: ' + id);
        // Implement detailed view
    }

    function viewDepositDetails(id) {
        toastr.info('View deposit details: ' + id);
        // Implement detailed view
    }

    function viewWithdrawalDetails(id) {
        toastr.info('View withdrawal details: ' + id);
        // Implement detailed view
    }

    function viewKYCDetails(id) {
        toastr.info('View KYC details: ' + id);
        // Implement detailed view
    }

    function viewSupportTicket(id) {
        toastr.info('View support ticket: ' + id);
        // Implement detailed view
    }

    function viewReferralDetails(id) {
        toastr.info('View referral details: ' + id);
        // Implement detailed view
    }

    function createNewPlan() {
        toastr.info('Create new plan feature will be available soon');
        // Implement plan creation
    }

    function editPlan(id) {
        toastr.info('Edit plan: ' + id);
        // Implement plan editing
    }

    function togglePlanStatus(id, activate) {
        toastr.info(`${activate ? 'Activate' : 'Deactivate'} plan: ${id}`);
        // Implement plan status toggle
    }

    function viewPlanStats(id) {
        toastr.info('View plan stats: ' + id);
        // Implement plan statistics
    }

    function updatePlatformSettings() {
        toastr.info('Platform settings updated');
        // Implement settings update
    }

    function updateEmailSettings() {
        toastr.info('Email settings updated');
        // Implement email settings update
    }

    function testEmailSettings() {
        toastr.info('Test email sent');
        // Implement email test
    }

    function checkSystemHealth() {
        toastr.info('System health check initiated');
        // Implement health check
    }

    // ==================== INITIALIZE PAGE COMPONENTS ====================
    function initializePageComponents() {
        // Destroy existing DataTables
        Object.values(dataTables).forEach(table => {
            if (table && $.fn.DataTable.isDataTable(table)) {
                table.destroy();
            }
        });
        
        dataTables = {};
        
        // Initialize DataTables for each table on the page
        $('table').each(function() {
            const tableId = $(this).attr('id');
            if (tableId) {
                dataTables[tableId] = $(this).DataTable({
                    pageLength: 10,
                    responsive: true,
                    order: [[0, 'desc']],
                    language: {
                        search: "Search:",
                        lengthMenu: "Show _MENU_ entries",
                        info: "Showing _START_ to _END_ of _TOTAL_ entries",
                        paginate: {
                            first: "First",
                            last: "Last",
                            next: "Next",
                            previous: "Previous"
                        }
                    }
                });
            }
        });
        
        // Initialize charts on dashboard
        if (currentPage === 'dashboard') {
            initializeDashboardCharts();
        }
        
        // Initialize search for each page
        initializeSearch();
    }

    function initializeDashboardCharts() {
        const ctx = document.getElementById('weeklyChart');
        if (ctx) {
            if (charts.weeklyChart) {
                charts.weeklyChart.destroy();
            }
            
            // Sample data - in real implementation, fetch from API
            charts.weeklyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Deposits',
                        data: [12000, 19000, 15000, 25000, 22000, 30000, 28000],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Withdrawals',
                        data: [8000, 12000, 10000, 15000, 18000, 22000, 20000],
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ₦${formatNumber(context.raw)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '₦' + formatNumber(value);
                                }
                            }
                        }
                    }
                }
            });
        }
    }

    function initializeSearch() {
        // Initialize search for each page
        switch(currentPage) {
            case 'users':
                $('#usersSearch').on('keyup', function() {
                    dataTables.usersTable.search(this.value).draw();
                });
                break;
            case 'kyc':
                $('#kycSearch').on('keyup', function() {
                    dataTables.kycTable.search(this.value).draw();
                });
                break;
        }
    }

    // Auto-refresh dashboard every 30 seconds
    setInterval(() => {
        if (currentPage === 'dashboard' && authToken) {
            loadDashboard().then(content => {
                if (content.includes('alert alert-danger')) {
                    // Don't replace if there's an error
                    return;
                }
                $('#pageContent').html(content);
                initializePageComponents();
            });
        }
    }, 30000);

    // Initialize on load
    $(document).ready(function() {
        if (authToken) {
            loadPage('dashboard');
        }
    });
</script>
</body>
</html>
