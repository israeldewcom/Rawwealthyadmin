
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raw Wealthy Admin Dashboard</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
    <!-- Toastr CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <!-- Custom CSS -->
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            --dark-color: #1f2937;
            --light-color: #f9fafb;
            --sidebar-width: 250px;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fb;
            overflow-x: hidden;
        }
        
        /* Sidebar Styles */
        #sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            position: fixed;
            height: 100vh;
            z-index: 1000;
            transition: all 0.3s;
            box-shadow: 3px 0 20px rgba(0,0,0,0.1);
        }
        
        .sidebar-header {
            padding: 20px;
            background: rgba(0,0,0,0.2);
        }
        
        .sidebar-header h3 {
            margin: 0;
            font-weight: 600;
        }
        
        .sidebar-header h3 i {
            margin-right: 10px;
        }
        
        .sidebar-menu {
            padding: 20px 0;
        }
        
        .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 12px 20px;
            margin: 2px 0;
            border-left: 4px solid transparent;
            transition: all 0.3s;
        }
        
        .nav-link:hover, .nav-link.active {
            color: white;
            background: rgba(255,255,255,0.1);
            border-left: 4px solid white;
        }
        
        .nav-link i {
            width: 25px;
            font-size: 1.1rem;
        }
        
        .sub-menu {
            padding-left: 40px;
            background: rgba(0,0,0,0.1);
            display: none;
        }
        
        .sub-menu.show {
            display: block;
        }
        
        .sub-menu .nav-link {
            padding: 8px 20px;
            font-size: 0.9rem;
        }
        
        /* Main Content */
        #content {
            margin-left: var(--sidebar-width);
            transition: all 0.3s;
            min-height: 100vh;
        }
        
        .top-navbar {
            background: white;
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .top-navbar .navbar-brand {
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .page-title {
            margin: 20px 0;
            color: var(--dark-color);
            font-weight: 600;
        }
        
        /* Card Styles */
        .dashboard-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: transform 0.3s, box-shadow 0.3s;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .card-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
            margin-bottom: 15px;
        }
        
        .card-icon.users {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
        }
        
        .card-icon.money {
            background: linear-gradient(45deg, var(--success-color), #34d399);
        }
        
        .card-icon.investments {
            background: linear-gradient(45deg, var(--info-color), #60a5fa);
        }
        
        .card-icon.pending {
            background: linear-gradient(45deg, var(--warning-color), #fbbf24);
        }
        
        .card-stat {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark-color);
        }
        
        .card-change {
            font-size: 0.85rem;
        }
        
        .card-change.positive {
            color: var(--success-color);
        }
        
        .card-change.negative {
            color: var(--danger-color);
        }
        
        /* Chart Container */
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        /* Table Styles */
        .data-table-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .table th {
            font-weight: 600;
            color: var(--dark-color);
            border-top: none;
        }
        
        .table td {
            vertical-align: middle;
        }
        
        /* Badge Styles */
        .badge-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 500;
        }
        
        .badge-pending {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .badge-active {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .badge-approved {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .badge-rejected {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .badge-paid {
            background-color: #dcfce7;
            color: #166534;
        }
        
        .badge-verified {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        /* Button Styles */
        .btn-action {
            padding: 5px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .btn-view {
            background-color: #e0e7ff;
            color: #4f46e5;
        }
        
        .btn-approve {
            background-color: #d1fae5;
            color: #059669;
        }
        
        .btn-reject {
            background-color: #fee2e2;
            color: #dc2626;
        }
        
        .btn-edit {
            background-color: #fef3c7;
            color: #d97706;
        }
        
        /* Modal Styles */
        .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border-radius: 15px 15px 0 0;
            padding: 20px 30px;
        }
        
        .modal-title {
            font-weight: 600;
        }
        
        /* Loading Spinner */
        .spinner-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 300px;
        }
        
        /* Image Preview */
        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .image-preview {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .image-preview:hover {
            transform: scale(1.05);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            #sidebar {
                margin-left: -250px;
            }
            
            #sidebar.active {
                margin-left: 0;
            }
            
            #content {
                margin-left: 0;
            }
            
            .sidebar-toggle {
                display: block;
            }
            
            .page-title {
                font-size: 1.5rem;
            }
        }
        
        /* Animation for page transitions */
        .page-content {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 10px;
        }
        
        /* Search Box */
        .search-box {
            position: relative;
        }
        
        .search-box input {
            padding-left: 40px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
        }
        
        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }
        
        /* Filter Dropdown */
        .filter-dropdown {
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 8px 15px;
            background: white;
            color: #6b7280;
            cursor: pointer;
        }
        
        /* Stats Cards Small */
        .stats-card-sm {
            background: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        .stats-card-sm .number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark-color);
        }
        
        .stats-card-sm .label {
            font-size: 0.85rem;
            color: #6b7280;
        }
        
        /* Activity Timeline */
        .activity-timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .activity-timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -25px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary-color);
            border: 3px solid white;
            box-shadow: 0 0 0 2px var(--primary-color);
        }
        
        .timeline-item .time {
            font-size: 0.8rem;
            color: #6b7280;
        }
        
        /* User Avatar */
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1rem;
        }
        
        /* Quick Stats */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        /* Notification Bell */
        .notification-bell {
            position: relative;
            cursor: pointer;
        }
        
        .notification-bell .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger-color);
            color: white;
            font-size: 0.7rem;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <nav id="sidebar">
        <div class="sidebar-header">
            <h3><i class="fas fa-gem"></i> Raw Wealthy</h3>
            <p class="mb-0" style="opacity: 0.8; font-size: 0.9rem;">Admin Dashboard v37.0</p>
        </div>
        
        <div class="sidebar-menu">
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" href="#" data-page="dashboard">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>
                </li>
                
                <li class="nav-item">
                    <a class="nav-link" href="#" data-page="users">
                        <i class="fas fa-users"></i> Users Management
                    </a>
                </li>
                
                <li class="nav-item">
                    <a class="nav-link" href="#" data-toggle="collapse" data-target="#financialSubmenu">
                        <i class="fas fa-money-bill-wave"></i> Financial Management
                        <i class="fas fa-chevron-down float-end mt-1"></i>
                    </a>
                    <div class="sub-menu" id="financialSubmenu">
                        <a class="nav-link" href="#" data-page="investments">
                            <i class="fas fa-chart-line"></i> Investments
                        </a>
                        <a class="nav-link" href="#" data-page="deposits">
                            <i class="fas fa-arrow-down"></i> Deposits
                        </a>
                        <a class="nav-link" href="#" data-page="withdrawals">
                            <i class="fas fa-arrow-up"></i> Withdrawals
                        </a>
                        <a class="nav-link" href="#" data-page="transactions">
                            <i class="fas fa-exchange-alt"></i> Transactions
                        </a>
                    </div>
                </li>
                
                <li class="nav-item">
                    <a class="nav-link" href="#" data-page="kyc">
                        <i class="fas fa-id-card"></i> KYC Verification
                    </a>
                </li>
                
                <li class="nav-item">
                    <a class="nav-link" href="#" data-page="plans">
                        <i class="fas fa-boxes"></i> Investment Plans
                    </a>
                </li>
                
                <li class="nav-item">
                    <a class="nav-link" href="#" data-page="support">
                        <i class="fas fa-headset"></i> Support Tickets
                    </a>
                </li>
                
                <li class="nav-item">
                    <a class="nav-link" href="#" data-page="referrals">
                        <i class="fas fa-user-friends"></i> Referrals
                    </a>
                </li>
                
                <li class="nav-item">
                    <a class="nav-link" href="#" data-toggle="collapse" data-target="#systemSubmenu">
                        <i class="fas fa-cogs"></i> System
                        <i class="fas fa-chevron-down float-end mt-1"></i>
                    </a>
                    <div class="sub-menu" id="systemSubmenu">
                        <a class="nav-link" href="#" data-page="notifications">
                            <i class="fas fa-bell"></i> Notifications
                        </a>
                        <a class="nav-link" href="#" data-page="audit-logs">
                            <i class="fas fa-clipboard-list"></i> Audit Logs
                        </a>
                        <a class="nav-link" href="#" data-page="settings">
                            <i class="fas fa-sliders-h"></i> Settings
                        </a>
                    </div>
                </li>
            </ul>
        </div>
        
        <div class="sidebar-footer" style="position: absolute; bottom: 20px; width: 100%; padding: 20px;">
            <div class="d-flex align-items-center">
                <div class="user-avatar me-3">
                    <span id="adminInitials">A</span>
                </div>
                <div>
                    <h6 class="mb-0" id="adminName">Admin User</h6>
                    <small style="opacity: 0.7;" id="adminRole">Super Admin</small>
                </div>
            </div>
            <button class="btn btn-sm btn-light w-100 mt-3" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </nav>
    
    <!-- Main Content -->
    <div id="content">
        <!-- Top Navbar -->
        <nav class="top-navbar">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <button class="btn btn-outline-primary d-md-none" id="sidebarToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h4 class="d-inline-block ms-3 page-title" id="pageTitle">Dashboard</h4>
                </div>
                
                <div class="d-flex align-items-center">
                    <div class="notification-bell me-3">
                        <i class="fas fa-bell fa-lg text-muted"></i>
                        <span class="badge" id="notificationCount">3</span>
                    </div>
                    <div class="search-box me-3">
                        <i class="fas fa-search"></i>
                        <input type="text" class="form-control" placeholder="Search..." id="globalSearch">
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="filterDropdown" data-bs-toggle="dropdown">
                            <i class="fas fa-filter"></i> Filters
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" data-filter="all">All</a></li>
                            <li><a class="dropdown-item" href="#" data-filter="today">Today</a></li>
                            <li><a class="dropdown-item" href="#" data-filter="week">This Week</a></li>
                            <li><a class="dropdown-item" href="#" data-filter="month">This Month</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>
        
        <!-- Page Content -->
        <div class="container-fluid p-4">
            <div id="pageContent">
                <!-- Content will be loaded here dynamically -->
                <div class="spinner-container">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    
    <!-- User Details Modal -->
    <div class="modal fade" id="userDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">User Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="userDetailsContent">
                    <!-- User details will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Approve/Reject Modal -->
    <div class="modal fade" id="actionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="actionModalTitle">Action</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="actionModalContent">
                        <!-- Content will be loaded here -->
                    </div>
                    <div class="mt-3">
                        <label for="actionRemarks" class="form-label">Remarks (Optional)</label>
                        <textarea class="form-control" id="actionRemarks" rows="3" placeholder="Enter remarks..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="rejectBtn">Reject</button>
                    <button type="button" class="btn btn-success" id="approveBtn">Approve</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Image Preview Modal -->
    <div class="modal fade" id="imagePreviewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Image Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img src="" alt="Preview" id="previewImage" class="img-fluid" style="max-height: 70vh;">
                </div>
            </div>
        </div>
    </div>
    
    <!-- Send Notification Modal -->
    <div class="modal fade" id="sendNotificationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Send Notification</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="notificationForm">
                        <div class="mb-3">
                            <label for="notificationTitle" class="form-label">Title</label>
                            <input type="text" class="form-control" id="notificationTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="notificationMessage" class="form-label">Message</label>
                            <textarea class="form-control" id="notificationMessage" rows="4" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="notificationType" class="form-label">Type</label>
                            <select class="form-select" id="notificationType">
                                <option value="info">Info</option>
                                <option value="success">Success</option>
                                <option value="warning">Warning</option>
                                <option value="error">Error</option>
                                <option value="promotional">Promotional</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="notificationTarget" class="form-label">Send To</label>
                            <select class="form-select" id="notificationTarget">
                                <option value="all">All Users</option>
                                <option value="specific">Specific User</option>
                            </select>
                        </div>
                        <div class="mb-3" id="specificUserField" style="display: none;">
                            <label for="specificUserId" class="form-label">User ID</label>
                            <input type="text" class="form-control" id="specificUserId" placeholder="Enter user ID">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="sendNotificationBtn">Send</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Update Balance Modal -->
    <div class="modal fade" id="updateBalanceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Update User Balance</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="updateBalanceForm">
                        <div class="mb-3">
                            <label class="form-label">User</label>
                            <input type="text" class="form-control" id="balanceUserName" readonly>
                            <input type="hidden" id="balanceUserId">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Current Balance</label>
                            <input type="text" class="form-control" id="currentBalance" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="balanceAction" class="form-label">Action</label>
                            <select class="form-select" id="balanceAction">
                                <option value="add">Add Funds</option>
                                <option value="subtract">Subtract Funds</option>
                                <option value="set">Set New Balance</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="balanceAmount" class="form-label">Amount (₦)</label>
                            <input type="number" class="form-control" id="balanceAmount" required min="0" step="0.01">
                        </div>
                        <div class="mb-3">
                            <label for="balanceDescription" class="form-label">Description</label>
                            <input type="text" class="form-control" id="balanceDescription" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="updateBalanceBtn">Update</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- DataTables -->
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <!-- Toastr -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    
    <!-- Main Application Script -->
    <script>
        // Configuration
        const API_BASE_URL = window.location.origin; // Same as server
        const API_ENDPOINTS = {
            dashboard: '/api/admin/dashboard',
            users: '/api/admin/users',
            userDetails: (id) => `/api/admin/users/${id}`,
            userDashboard: (id) => `/api/admin/users/${id}/dashboard`,
            updateBalance: (id) => `/api/admin/users/${id}/balance`,
            verifyBank: (id) => `/api/admin/users/${id}/verify-bank`,
            updateUserRole: (id) => `/api/admin/users/${id}/role`,
            updateUserStatus: (id) => `/api/admin/users/${id}/status`,
            investments: '/api/investments',
            pendingInvestments: '/api/admin/pending-investments',
            approveInvestment: (id) => `/api/admin/investments/${id}/approve`,
            rejectInvestment: (id) => `/api/admin/investments/${id}/reject`,
            deposits: '/api/deposits',
            pendingDeposits: '/api/admin/pending-deposits',
            approveDeposit: (id) => `/api/admin/deposits/${id}/approve`,
            rejectDeposit: (id) => `/api/admin/deposits/${id}/reject`,
            withdrawals: '/api/withdrawals',
            pendingWithdrawals: '/api/admin/pending-withdrawals',
            approveWithdrawal: (id) => `/api/admin/withdrawals/${id}/approve`,
            rejectWithdrawal: (id) => `/api/admin/withdrawals/${id}/reject`,
            transactions: '/api/admin/transactions',
            kyc: '/api/kyc/status',
            pendingKYC: '/api/admin/pending-kyc',
            approveKYC: (id) => `/api/admin/kyc/${id}/approve`,
            rejectKYC: (id) => `/api/admin/kyc/${id}/reject`,
            plans: '/api/plans',
            supportTickets: '/api/support/tickets',
            referrals: '/api/referrals/stats',
            notifications: '/api/notifications',
            sendNotification: '/api/admin/notifications/send',
            markNotificationRead: (id) => `/api/notifications/${id}/read`,
            markAllNotificationsRead: '/api/notifications/read-all',
            auditLogs: '/api/admin/audit-logs',
            login: '/api/auth/login',
            profile: '/api/profile'
        };

        // Global State
        let currentUser = null;
        let authToken = localStorage.getItem('admin_token');
        let currentPage = 'dashboard';
        let currentFilter = 'all';
        let dataTables = {};
        let charts = {};

        // Toastr Configuration
        toastr.options = {
            "closeButton": true,
            "debug": false,
            "newestOnTop": true,
            "progressBar": true,
            "positionClass": "toast-top-right",
            "preventDuplicates": false,
            "onclick": null,
            "showDuration": "300",
            "hideDuration": "1000",
            "timeOut": "5000",
            "extendedTimeOut": "1000",
            "showEasing": "swing",
            "hideEasing": "linear",
            "showMethod": "fadeIn",
            "hideMethod": "fadeOut"
        };

        // Initialize Application
        $(document).ready(function() {
            checkAuth();
            initEventListeners();
            loadAdminProfile();
        });

        // Authentication Functions
        function checkAuth() {
            if (!authToken) {
                showLoginPage();
            } else {
                verifyToken();
            }
        }

        function showLoginPage() {
            $('#sidebar').hide();
            $('#content').html(`
                <div class="container">
                    <div class="row justify-content-center align-items-center min-vh-100">
                        <div class="col-md-6 col-lg-4">
                            <div class="card dashboard-card">
                                <div class="card-body p-5">
                                    <div class="text-center mb-4">
                                        <h3 class="fw-bold" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                                            <i class="fas fa-gem"></i> Raw Wealthy
                                        </h3>
                                        <p class="text-muted">Admin Dashboard v37.0</p>
                                    </div>
                                    
                                    <form id="loginForm">
                                        <div class="mb-3">
                                            <label for="loginEmail" class="form-label">Email Address</label>
                                            <input type="email" class="form-control" id="loginEmail" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="loginPassword" class="form-label">Password</label>
                                            <input type="password" class="form-control" id="loginPassword" required>
                                        </div>
                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-primary btn-lg">
                                                <i class="fas fa-sign-in-alt"></i> Login
                                            </button>
                                        </div>
                                    </form>
                                    
                                    <div class="mt-3 text-center">
                                        <small class="text-muted">Contact support if you forgot your credentials</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `);

            $('#loginForm').on('submit', function(e) {
                e.preventDefault();
                login();
            });
        }

        async function login() {
            const email = $('#loginEmail').val();
            const password = $('#loginPassword').val();

            try {
                const response = await fetch(`${API_BASE_URL}${API_ENDPOINTS.login}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (data.success && data.data.user.role !== 'user') {
                    authToken = data.data.token;
                    localStorage.setItem('admin_token', authToken);
                    currentUser = data.data.user;
                    location.reload();
                } else {
                    toastr.error('Invalid credentials or insufficient privileges');
                }
            } catch (error) {
                toastr.error('Login failed. Please try again.');
            }
        }

        async function verifyToken() {
            try {
                const response = await fetch(`${API_BASE_URL}${API_ENDPOINTS.profile}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                
                if (data.success && data.data.user.role !== 'user') {
                    currentUser = data.data.user;
                    loadPage('dashboard');
                } else {
                    localStorage.removeItem('admin_token');
                    showLoginPage();
                }
            } catch (error) {
                localStorage.removeItem('admin_token');
                showLoginPage();
            }
        }

        function logout() {
            localStorage.removeItem('admin_token');
            authToken = null;
            currentUser = null;
            showLoginPage();
        }

        // Event Listeners
        function initEventListeners() {
            // Sidebar toggle
            $('#sidebarToggle').click(function() {
                $('#sidebar').toggleClass('active');
            });

            // Navigation
            $('.nav-link[data-page]').click(function(e) {
                e.preventDefault();
                const page = $(this).data('page');
                loadPage(page);
                
                // Update active state
                $('.nav-link').removeClass('active');
                $(this).addClass('active');
                
                // Close mobile sidebar
                if ($(window).width() < 768) {
                    $('#sidebar').removeClass('active');
                }
            });

            // Submenu toggle
            $('.nav-link[data-toggle="collapse"]').click(function(e) {
                e.preventDefault();
                const target = $(this).data('target');
                $(target).toggleClass('show');
                $(this).find('.fa-chevron-down').toggleClass('fa-chevron-up');
            });

            // Logout button
            $('#logoutBtn').click(logout);

            // Global search
            $('#globalSearch').on('keyup', function() {
                const searchTerm = $(this).val().toLowerCase();
                filterCurrentPage(searchTerm);
            });

            // Filter dropdown
            $('.dropdown-item[data-filter]').click(function(e) {
                e.preventDefault();
                currentFilter = $(this).data('filter');
                $('#filterDropdown').text($(this).text());
                applyFilter();
            });

            // Notification bell
            $('.notification-bell').click(function() {
                loadPage('notifications');
            });

            // Image preview
            $(document).on('click', '.image-preview', function() {
                const src = $(this).attr('src');
                $('#previewImage').attr('src', src);
                $('#imagePreviewModal').modal('show');
            });

            // Action modal buttons
            $('#approveBtn').click(performApproveAction);
            $('#rejectBtn').click(performRejectAction);

            // Notification target toggle
            $('#notificationTarget').change(function() {
                if ($(this).val() === 'specific') {
                    $('#specificUserField').show();
                } else {
                    $('#specificUserField').hide();
                }
            });

            // Send notification
            $('#sendNotificationBtn').click(sendNotification);

            // Update balance
            $('#updateBalanceBtn').click(updateUserBalance);
        }

        // Page Loading
        async function loadPage(page) {
            currentPage = page;
            $('#pageTitle').text(formatPageTitle(page));
            
            // Show loading spinner
            $('#pageContent').html(`
                <div class="spinner-container">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `);

            try {
                let content = '';
                
                switch(page) {
                    case 'dashboard':
                        content = await loadDashboard();
                        break;
                    case 'users':
                        content = await loadUsers();
                        break;
                    case 'investments':
                        content = await loadInvestments();
                        break;
                    case 'deposits':
                        content = await loadDeposits();
                        break;
                    case 'withdrawals':
                        content = await loadWithdrawals();
                        break;
                    case 'transactions':
                        content = await loadTransactions();
                        break;
                    case 'kyc':
                        content = await loadKYC();
                        break;
                    case 'plans':
                        content = await loadPlans();
                        break;
                    case 'support':
                        content = await loadSupportTickets();
                        break;
                    case 'referrals':
                        content = await loadReferrals();
                        break;
                    case 'notifications':
                        content = await loadNotifications();
                        break;
                    case 'audit-logs':
                        content = await loadAuditLogs();
                        break;
                    case 'settings':
                        content = await loadSettings();
                        break;
                    default:
                        content = '<div class="alert alert-info">Page not found</div>';
                }
                
                $('#pageContent').html(content);
                initializePageComponents();
            } catch (error) {
                console.error('Error loading page:', error);
                $('#pageContent').html(`
                    <div class="alert alert-danger">
                        <h5>Error loading page</h5>
                        <p>${error.message}</p>
                        <button class="btn btn-primary mt-2" onclick="loadPage('${page}')">Retry</button>
                    </div>
                `);
            }
        }

        function formatPageTitle(page) {
            const titles = {
                'dashboard': 'Dashboard',
                'users': 'Users Management',
                'investments': 'Investments',
                'deposits': 'Deposits',
                'withdrawals': 'Withdrawals',
                'transactions': 'Transactions',
                'kyc': 'KYC Verification',
                'plans': 'Investment Plans',
                'support': 'Support Tickets',
                'referrals': 'Referrals System',
                'notifications': 'Notifications',
                'audit-logs': 'Audit Logs',
                'settings': 'System Settings'
            };
            return titles[page] || page;
        }

        // API Helper Functions
        async function makeRequest(endpoint, method = 'GET', data = null) {
            const options = {
                method: method,
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                }
            };

            if (data) {
                options.body = JSON.stringify(data);
            }

            const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
            
            if (response.status === 401) {
                logout();
                throw new Error('Unauthorized');
            }

            return await response.json();
        }

        // Page Loaders
        async function loadDashboard() {
            try {
                const data = await makeRequest(API_ENDPOINTS.dashboard);
                
                if (!data.success) throw new Error(data.message);
                
                const stats = data.data.stats;
                
                return `
                    <div class="page-content">
                        <!-- Quick Stats -->
                        <div class="quick-stats">
                            <div class="stats-card-sm">
                                <div class="number">${stats.overview.total_users}</div>
                                <div class="label">Total Users</div>
                            </div>
                            <div class="stats-card-sm">
                                <div class="number">${stats.overview.active_investments}</div>
                                <div class="label">Active Investments</div>
                            </div>
                            <div class="stats-card-sm">
                                <div class="number">₦${formatNumber(stats.overview.total_active_value)}</div>
                                <div class="label">Active Value</div>
                            </div>
                            <div class="stats-card-sm">
                                <div class="number">${stats.pending_actions.total_pending}</div>
                                <div class="label">Pending Actions</div>
                            </div>
                        </div>
                        
                        <!-- Main Stats Cards -->
                        <div class="row">
                            <div class="col-md-3">
                                <div class="card dashboard-card">
                                    <div class="card-body">
                                        <div class="card-icon users">
                                            <i class="fas fa-users"></i>
                                        </div>
                                        <h6 class="card-subtitle mb-2 text-muted">Total Users</h6>
                                        <h4 class="card-stat">${stats.overview.total_users}</h4>
                                        <div class="card-change positive">
                                            <i class="fas fa-arrow-up"></i> ${stats.overview.new_users_today} today
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="card dashboard-card">
                                    <div class="card-body">
                                        <div class="card-icon money">
                                            <i class="fas fa-money-bill-wave"></i>
                                        </div>
                                        <h6 class="card-subtitle mb-2 text-muted">Platform Revenue</h6>
                                        <h4 class="card-stat">₦${formatNumber(stats.overview.platform_revenue)}</h4>
                                        <div class="card-change positive">
                                            <i class="fas fa-arrow-up"></i> ${stats.period_stats.weekly.deposits_count} deposits
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="card dashboard-card">
                                    <div class="card-body">
                                        <div class="card-icon investments">
                                            <i class="fas fa-chart-line"></i>
                                        </div>
                                        <h6 class="card-subtitle mb-2 text-muted">Total Investments</h6>
                                        <h4 class="card-stat">${stats.overview.total_investments}</h4>
                                        <div class="card-change positive">
                                            <i class="fas fa-arrow-up"></i> ${stats.period_stats.weekly.investments_count} this week
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="card dashboard-card">
                                    <div class="card-body">
                                        <div class="card-icon pending">
                                            <i class="fas fa-clock"></i>
                                        </div>
                                        <h6 class="card-subtitle mb-2 text-muted">Pending Actions</h6>
                                        <h4 class="card-stat">${stats.pending_actions.total_pending}</h4>
                                        <div class="card-change negative">
                                            <i class="fas fa-exclamation-circle"></i> Needs attention
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Charts and Pending Actions -->
                        <div class="row">
                            <div class="col-lg-8">
                                <div class="chart-container">
                                    <h5>Weekly Performance</h5>
                                    <canvas id="weeklyChart" height="250"></canvas>
                                </div>
                            </div>
                            
                            <div class="col-lg-4">
                                <div class="data-table-container">
                                    <h5>Pending Actions</h5>
                                    <div class="list-group">
                                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="loadPage('investments')">
                                            Pending Investments
                                            <span class="badge bg-warning rounded-pill">${stats.pending_actions.pending_investments}</span>
                                        </a>
                                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="loadPage('deposits')">
                                            Pending Deposits
                                            <span class="badge bg-warning rounded-pill">${stats.pending_actions.pending_deposits}</span>
                                        </a>
                                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="loadPage('withdrawals')">
                                            Pending Withdrawals
                                            <span class="badge bg-warning rounded-pill">${stats.pending_actions.pending_withdrawals}</span>
                                        </a>
                                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="loadPage('kyc')">
                                            Pending KYC
                                            <span class="badge bg-warning rounded-pill">${stats.pending_actions.pending_kyc}</span>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Recent Activity -->
                        <div class="row mt-4">
                            <div class="col-lg-6">
                                <div class="data-table-container">
                                    <h5>Recent Users</h5>
                                    <div class="table-responsive">
                                        <table class="table table-hover" id="recentUsersTable">
                                            <thead>
                                                <tr>
                                                    <th>User</th>
                                                    <th>Email</th>
                                                    <th>Joined</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${stats.recent_activity.users.map(user => `
                                                    <tr>
                                                        <td>
                                                            <div class="d-flex align-items-center">
                                                                <div class="user-avatar me-2">
                                                                    ${user.full_name.charAt(0)}
                                                                </div>
                                                                <div>
                                                                    <strong>${user.full_name}</strong><br>
                                                                    <small class="text-muted">${user.phone || 'No phone'}</small>
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td>${user.email}</td>
                                                        <td>${formatDate(user.createdAt)}</td>
                                                        <td>
                                                            <span class="badge-status ${user.is_active ? 'badge-active' : 'badge-rejected'}">
                                                                ${user.is_active ? 'Active' : 'Inactive'}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-lg-6">
                                <div class="data-table-container">
                                    <h5>Recent Transactions</h5>
                                    <div class="activity-timeline">
                                        ${stats.recent_activity.transactions.slice(0, 8).map(txn => `
                                            <div class="timeline-item">
                                                <div class="d-flex justify-content-between">
                                                    <strong>${txn.description}</strong>
                                                    <span class="time">${formatDate(txn.createdAt, true)}</span>
                                                </div>
                                                <div class="d-flex justify-content-between">
                                                    <small class="text-muted">${txn.user?.full_name || 'System'}</small>
                                                    <span class="${txn.amount > 0 ? 'text-success' : 'text-danger'}">
                                                        ${txn.amount > 0 ? '+' : ''}₦${formatNumber(Math.abs(txn.amount))}
                                                    </span>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                return `
                    <div class="alert alert-danger">
                        <h5>Error loading dashboard</h5>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function loadUsers() {
            try {
                const data = await makeRequest(API_ENDPOINTS.users);
                
                if (!data.success) throw new Error(data.message);
                
                return `
                    <div class="page-content">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5>Users Management (${data.data.users.length})</h5>
                            <div>
                                <button class="btn btn-primary" onclick="exportUsers()">
                                    <i class="fas fa-download"></i> Export
                                </button>
                            </div>
                        </div>
                        
                        <div class="data-table-container">
                            <div class="table-responsive">
                                <table class="table table-hover" id="usersTable">
                                    <thead>
                                        <tr>
                                            <th>User</th>
                                            <th>Email</th>
                                            <th>Balance</th>
                                            <th>Status</th>
                                            <th>KYC</th>
                                            <th>Joined</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.data.users.map(user => `
                                            <tr>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="user-avatar me-2">
                                                            ${user.full_name.charAt(0)}
                                                        </div>
                                                        <div>
                                                            <strong>${user.full_name}</strong><br>
                                                            <small class="text-muted">${user.phone || 'No phone'}</small>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>${user.email}</td>
                                                <td>
                                                    <strong>₦${formatNumber(user.balance)}</strong><br>
                                                    <small class="text-muted">Portfolio: ₦${formatNumber(user.stats?.portfolio_value || 0)}</small>
                                                </td>
                                                <td>
                                                    <span class="badge-status ${user.is_active ? 'badge-active' : 'badge-rejected'}">
                                                        ${user.is_active ? 'Active' : 'Inactive'}
                                                    </span><br>
                                                    <small class="text-muted">${user.role}</small>
                                                </td>
                                                <td>
                                                    <span class="badge-status ${user.kyc_verified ? 'badge-verified' : 'badge-pending'}">
                                                        ${user.kyc_status || 'Not Submitted'}
                                                    </span>
                                                </td>
                                                <td>${formatDate(user.createdAt)}</td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-action btn-view" onclick="viewUserDetails('${user._id}')">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                        <button class="btn btn-action btn-edit" onclick="updateUserBalanceModal('${user._id}', '${user.full_name}', ${user.balance})">
                                                            <i class="fas fa-coins"></i>
                                                        </button>
                                                        <div class="dropdown">
                                                            <button class="btn btn-action" type="button" data-bs-toggle="dropdown">
                                                                <i class="fas fa-ellipsis-v"></i>
                                                            </button>
                                                            <ul class="dropdown-menu">
                                                                <li><a class="dropdown-item" href="#" onclick="toggleUserStatus('${user._id}', ${!user.is_active})">
                                                                    ${user.is_active ? '<i class="fas fa-ban text-danger"></i> Deactivate' : '<i class="fas fa-check text-success"></i> Activate'}
                                                                </a></li>
                                                                <li><a class="dropdown-item" href="#" onclick="changeUserRole('${user._id}')">
                                                                    <i class="fas fa-user-tag"></i> Change Role
                                                                </a></li>
                                                                ${user.bank_details?.account_number ? `
                                                                    <li><a class="dropdown-item" href="#" onclick="verifyBankDetails('${user._id}', ${!user.bank_details?.verified})">
                                                                        ${user.bank_details?.verified ? '<i class="fas fa-times text-danger"></i> Unverify Bank' : '<i class="fas fa-check text-success"></i> Verify Bank'}
                                                                    </a></li>
                                                                ` : ''}
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                return `
                    <div class="alert alert-danger">
                        <h5>Error loading users</h5>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function loadInvestments() {
            try {
                const pendingData = await makeRequest(API_ENDPOINTS.pendingInvestments);
                const allData = await makeRequest(API_ENDPOINTS.investments);
                
                return `
                    <div class="page-content">
                        <h5 class="mb-4">Investments Management</h5>
                        
                        <!-- Pending Investments -->
                        ${pendingData.data?.investments?.length > 0 ? `
                            <div class="alert alert-warning mb-4">
                                <h6><i class="fas fa-exclamation-triangle"></i> ${pendingData.data.count} Pending Investments Require Approval</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>User</th>
                                                <th>Plan</th>
                                                <th>Amount</th>
                                                <th>Proof</th>
                                                <th>Date</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${pendingData.data.investments.slice(0, 5).map(inv => `
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="user-avatar me-2">
                                                                ${inv.user_details.name.charAt(0)}
                                                            </div>
                                                            <div>
                                                                <strong>${inv.user_details.name}</strong><br>
                                                                <small class="text-muted">${inv.user_details.email}</small>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>${inv.plan?.name || 'N/A'}</td>
                                                    <td><strong>₦${formatNumber(inv.amount)}</strong></td>
                                                    <td>
                                                        ${inv.has_proof ? `
                                                            <button class="btn btn-sm btn-outline-primary" onclick="viewImage('${inv.proof_url}')">
                                                                <i class="fas fa-image"></i> View
                                                            </button>
                                                        ` : '<span class="text-muted">No proof</span>'}
                                                    </td>
                                                    <td>${formatDate(inv.createdAt)}</td>
                                                    <td>
                                                        <div class="btn-group btn-group-sm">
                                                            <button class="btn btn-success" onclick="showActionModal('investment', '${inv._id}', 'approve')">
                                                                <i class="fas fa-check"></i>
                                                            </button>
                                                            <button class="btn btn-danger" onclick="showActionModal('investment', '${inv._id}', 'reject')">
                                                                <i class="fas fa-times"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                                ${pendingData.data.count > 5 ? `
                                    <div class="text-center mt-2">
                                        <a href="#" class="text-warning" onclick="viewAllPending('investments')">View all ${pendingData.data.count} pending investments</a>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        <!-- All Investments -->
                        <div class="data-table-container">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6>All Investments</h6>
                                <div class="btn-group">
                                    <button class="btn btn-sm ${currentFilter === 'all' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('all')">All</button>
                                    <button class="btn btn-sm ${currentFilter === 'active' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('active')">Active</button>
                                    <button class="btn btn-sm ${currentFilter === 'pending' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('pending')">Pending</button>
                                    <button class="btn btn-sm ${currentFilter === 'completed' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('completed')">Completed</button>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-hover" id="investmentsTable">
                                    <thead>
                                        <tr>
                                            <th>User</th>
                                            <th>Plan</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                            <th>Start Date</th>
                                            <th>End Date</th>
                                            <th>Earnings</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${allData.data?.investments?.map(inv => `
                                            <tr>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="user-avatar me-2">
                                                            ${inv.user?.full_name?.charAt(0) || 'U'}
                                                        </div>
                                                        <div>
                                                            <strong>${inv.user?.full_name || 'Unknown'}</strong><br>
                                                            <small class="text-muted">${inv.user?.email || ''}</small>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>${inv.plan?.name || 'N/A'}</td>
                                                <td><strong>₦${formatNumber(inv.amount)}</strong></td>
                                                <td>
                                                    <span class="badge-status badge-${inv.status}">
                                                        ${inv.status}
                                                    </span>
                                                </td>
                                                <td>${formatDate(inv.start_date)}</td>
                                                <td>${formatDate(inv.end_date)}</td>
                                                <td>
                                                    <small>Earned: ₦${formatNumber(inv.earned_so_far || 0)}</small><br>
                                                    <small>Expected: ₦${formatNumber(inv.expected_earnings || 0)}</small>
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary" onclick="viewInvestmentDetails('${inv._id}')">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('') || '<tr><td colspan="8" class="text-center">No investments found</td></tr>'}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                return `
                    <div class="alert alert-danger">
                        <h5>Error loading investments</h5>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function loadDeposits() {
            try {
                const pendingData = await makeRequest(API_ENDPOINTS.pendingDeposits);
                const allData = await makeRequest(API_ENDPOINTS.deposits);
                
                return `
                    <div class="page-content">
                        <h5 class="mb-4">Deposits Management</h5>
                        
                        <!-- Pending Deposits -->
                        ${pendingData.data?.deposits?.length > 0 ? `
                            <div class="alert alert-warning mb-4">
                                <h6><i class="fas fa-exclamation-triangle"></i> ${pendingData.data.count} Pending Deposits Require Approval</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>User</th>
                                                <th>Amount</th>
                                                <th>Method</th>
                                                <th>Proof</th>
                                                <th>Date</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${pendingData.data.deposits.slice(0, 5).map(dep => `
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="user-avatar me-2">
                                                                ${dep.user_details.name.charAt(0)}
                                                            </div>
                                                            <div>
                                                                <strong>${dep.user_details.name}</strong><br>
                                                                <small class="text-muted">${dep.user_details.email}</small>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td><strong>₦${formatNumber(dep.amount)}</strong></td>
                                                    <td>${dep.payment_method}</td>
                                                    <td>
                                                        ${dep.has_proof ? `
                                                            <button class="btn btn-sm btn-outline-primary" onclick="viewImage('${dep.proof_url}')">
                                                                <i class="fas fa-image"></i> View
                                                            </button>
                                                        ` : '<span class="text-muted">No proof</span>'}
                                                    </td>
                                                    <td>${formatDate(dep.createdAt)}</td>
                                                    <td>
                                                        <div class="btn-group btn-group-sm">
                                                            <button class="btn btn-success" onclick="showActionModal('deposit', '${dep._id}', 'approve')">
                                                                <i class="fas fa-check"></i>
                                                            </button>
                                                            <button class="btn btn-danger" onclick="showActionModal('deposit', '${dep._id}', 'reject')">
                                                                <i class="fas fa-times"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                                ${pendingData.data.count > 5 ? `
                                    <div class="text-center mt-2">
                                        <a href="#" class="text-warning" onclick="viewAllPending('deposits')">View all ${pendingData.data.count} pending deposits</a>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        <!-- All Deposits -->
                        <div class="data-table-container">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6>All Deposits</h6>
                                <div class="btn-group">
                                    <button class="btn btn-sm ${currentFilter === 'all' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('all')">All</button>
                                    <button class="btn btn-sm ${currentFilter === 'pending' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('pending')">Pending</button>
                                    <button class="btn btn-sm ${currentFilter === 'approved' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('approved')">Approved</button>
                                    <button class="btn btn-sm ${currentFilter === 'rejected' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('rejected')">Rejected</button>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-hover" id="depositsTable">
                                    <thead>
                                        <tr>
                                            <th>User</th>
                                            <th>Amount</th>
                                            <th>Method</th>
                                            <th>Status</th>
                                            <th>Date</th>
                                            <th>Proof</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${allData.data?.deposits?.map(dep => `
                                            <tr>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="user-avatar me-2">
                                                            ${dep.user?.full_name?.charAt(0) || 'U'}
                                                        </div>
                                                        <div>
                                                            <strong>${dep.user?.full_name || 'Unknown'}</strong><br>
                                                            <small class="text-muted">${dep.user?.email || ''}</small>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td><strong>₦${formatNumber(dep.amount)}</strong></td>
                                                <td>${dep.payment_method}</td>
                                                <td>
                                                    <span class="badge-status badge-${dep.status}">
                                                        ${dep.status}
                                                    </span>
                                                </td>
                                                <td>${formatDate(dep.createdAt)}</td>
                                                <td>
                                                    ${dep.has_proof ? `
                                                        <button class="btn btn-sm btn-outline-primary" onclick="viewImage('${dep.proof_url}')">
                                                            <i class="fas fa-image"></i>
                                                        </button>
                                                    ` : '<span class="text-muted">No proof</span>'}
                                                </td>
                                                <td>
                                                    ${dep.status === 'pending' ? `
                                                        <div class="btn-group btn-group-sm">
                                                            <button class="btn btn-success" onclick="showActionModal('deposit', '${dep._id}', 'approve')">
                                                                <i class="fas fa-check"></i>
                                                            </button>
                                                            <button class="btn btn-danger" onclick="showActionModal('deposit', '${dep._id}', 'reject')">
                                                                <i class="fas fa-times"></i>
                                                            </button>
                                                        </div>
                                                    ` : '<button class="btn btn-sm btn-outline-primary" onclick="viewDepositDetails(\'' + dep._id + '\')"><i class="fas fa-eye"></i></button>'}
                                                </td>
                                            </tr>
                                        `).join('') || '<tr><td colspan="7" class="text-center">No deposits found</td></tr>'}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                return `
                    <div class="alert alert-danger">
                        <h5>Error loading deposits</h5>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function loadWithdrawals() {
            try {
                const pendingData = await makeRequest(API_ENDPOINTS.pendingWithdrawals);
                
                return `
                    <div class="page-content">
                        <h5 class="mb-4">Withdrawals Management</h5>
                        
                        <!-- Pending Withdrawals -->
                        ${pendingData.data?.withdrawals?.length > 0 ? `
                            <div class="alert alert-warning mb-4">
                                <h6><i class="fas fa-exclamation-triangle"></i> ${pendingData.data.count} Pending Withdrawals Require Approval</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>User</th>
                                                <th>Amount</th>
                                                <th>Method</th>
                                                <th>Net Amount</th>
                                                <th>Date</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${pendingData.data.withdrawals.slice(0, 5).map(wdl => `
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="user-avatar me-2">
                                                                ${wdl.user_details.name.charAt(0)}
                                                            </div>
                                                            <div>
                                                                <strong>${wdl.user_details.name}</strong><br>
                                                                <small class="text-muted">${wdl.user_details.email}</small>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td><strong>₦${formatNumber(wdl.amount)}</strong></td>
                                                    <td>${wdl.payment_method}</td>
                                                    <td>₦${formatNumber(wdl.net_amount)}</td>
                                                    <td>${formatDate(wdl.createdAt)}</td>
                                                    <td>
                                                        <div class="btn-group btn-group-sm">
                                                            <button class="btn btn-success" onclick="showActionModal('withdrawal', '${wdl._id}', 'approve')">
                                                                <i class="fas fa-check"></i>
                                                            </button>
                                                            <button class="btn btn-danger" onclick="showActionModal('withdrawal', '${wdl._id}', 'reject')">
                                                                <i class="fas fa-times"></i>
                                                            </button>
                                                            <button class="btn btn-info" onclick="viewWithdrawalDetails('${wdl._id}')">
                                                                <i class="fas fa-eye"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                                ${pendingData.data.count > 5 ? `
                                    <div class="text-center mt-2">
                                        <a href="#" class="text-warning" onclick="viewAllPending('withdrawals')">View all ${pendingData.data.count} pending withdrawals</a>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        <!-- All Withdrawals -->
                        <div class="data-table-container">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6>All Withdrawals</h6>
                                <div class="btn-group">
                                    <button class="btn btn-sm ${currentFilter === 'all' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('all')">All</button>
                                    <button class="btn btn-sm ${currentFilter === 'pending' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('pending')">Pending</button>
                                    <button class="btn btn-sm ${currentFilter === 'paid' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('paid')">Paid</button>
                                    <button class="btn btn-sm ${currentFilter === 'rejected' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('rejected')">Rejected</button>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-hover" id="withdrawalsTable">
                                    <thead>
                                        <tr>
                                            <th>User</th>
                                            <th>Amount</th>
                                            <th>Method</th>
                                            <th>Status</th>
                                            <th>Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="withdrawalsBody">
                                        <!-- Data will be loaded via AJAX -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                return `
                    <div class="alert alert-danger">
                        <h5>Error loading withdrawals</h5>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function loadTransactions() {
            return `
                <div class="page-content">
                    <h5 class="mb-4">Transactions History</h5>
                    
                    <div class="data-table-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6>All Transactions</h6>
                            <div class="btn-group">
                                <button class="btn btn-sm ${currentFilter === 'all' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('all')">All</button>
                                <button class="btn btn-sm ${currentFilter === 'deposit' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('deposit')">Deposits</button>
                                <button class="btn btn-sm ${currentFilter === 'withdrawal' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('withdrawal')">Withdrawals</button>
                                <button class="btn btn-sm ${currentFilter === 'investment' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('investment')">Investments</button>
                                <button class="btn btn-sm ${currentFilter === 'earning' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('earning')">Earnings</button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover" id="transactionsTable">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Type</th>
                                        <th>Amount</th>
                                        <th>Description</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                        <th>Proof</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionsBody">
                                    <!-- Data will be loaded via AJAX -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadKYC() {
            try {
                const pendingData = await makeRequest(API_ENDPOINTS.pendingKYC);
                
                return `
                    <div class="page-content">
                        <h5 class="mb-4">KYC Verification</h5>
                        
                        <!-- Pending KYC -->
                        ${pendingData.data?.kyc_submissions?.length > 0 ? `
                            <div class="alert alert-warning mb-4">
                                <h6><i class="fas fa-exclamation-triangle"></i> ${pendingData.data.count} Pending KYC Submissions</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>User</th>
                                                <th>ID Type</th>
                                                <th>ID Number</th>
                                                <th>Documents</th>
                                                <th>Submitted</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${pendingData.data.kyc_submissions.slice(0, 5).map(kyc => `
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="user-avatar me-2">
                                                                ${kyc.user_name.charAt(0)}
                                                            </div>
                                                            <div>
                                                                <strong>${kyc.user_name}</strong><br>
                                                                <small class="text-muted">${kyc.user_email}</small>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>${formatIdType(kyc.id_type)}</td>
                                                    <td>${kyc.id_number}</td>
                                                    <td>
                                                        <div class="image-preview-container">
                                                            ${kyc.images.id_front ? `<img src="${kyc.images.id_front}" class="image-preview" alt="ID Front">` : ''}
                                                            ${kyc.images.selfie ? `<img src="${kyc.images.selfie}" class="image-preview" alt="Selfie">` : ''}
                                                        </div>
                                                    </td>
                                                    <td>${formatDate(kyc.createdAt)}</td>
                                                    <td>
                                                        <div class="btn-group btn-group-sm">
                                                            <button class="btn btn-success" onclick="showActionModal('kyc', '${kyc._id}', 'approve')">
                                                                <i class="fas fa-check"></i>
                                                            </button>
                                                            <button class="btn btn-danger" onclick="showActionModal('kyc', '${kyc._id}', 'reject')">
                                                                <i class="fas fa-times"></i>
                                                            </button>
                                                            <button class="btn btn-info" onclick="viewKYCDetails('${kyc._id}')">
                                                                <i class="fas fa-eye"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                                ${pendingData.data.count > 5 ? `
                                    <div class="text-center mt-2">
                                        <a href="#" class="text-warning" onclick="viewAllPending('kyc')">View all ${pendingData.data.count} pending KYC</a>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        <!-- KYC Statistics -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="stats-card-sm">
                                    <div class="number">${pendingData.data?.summary?.complete_submissions || 0}</div>
                                    <div class="label">Complete Submissions</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stats-card-sm">
                                    <div class="number">${pendingData.data?.summary?.incomplete_submissions || 0}</div>
                                    <div class="label">Incomplete</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stats-card-sm">
                                    <div class="number">${pendingData.data?.summary?.with_address_proof || 0}</div>
                                    <div class="label">With Address Proof</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stats-card-sm">
                                    <div class="number">${pendingData.data?.count || 0}</div>
                                    <div class="label">Total Pending</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Search KYC -->
                        <div class="data-table-container">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6>KYC Submissions</h6>
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" class="form-control" placeholder="Search by name or ID..." id="kycSearch">
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-hover" id="kycTable">
                                    <thead>
                                        <tr>
                                            <th>User</th>
                                            <th>ID Type</th>
                                            <th>ID Number</th>
                                            <th>Status</th>
                                            <th>Submitted</th>
                                            <th>Verified</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="kycBody">
                                        <!-- Data will be loaded via AJAX -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                return `
                    <div class="alert alert-danger">
                        <h5>Error loading KYC</h5>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function loadPlans() {
            try {
                const data = await makeRequest(API_ENDPOINTS.plans);
                
                return `
                    <div class="page-content">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5>Investment Plans</h5>
                            <button class="btn btn-primary" onclick="createNewPlan()">
                                <i class="fas fa-plus"></i> Create New Plan
                            </button>
                        </div>
                        
                        <div class="row">
                            ${data.data?.plans?.map(plan => `
                                <div class="col-md-4 mb-4">
                                    <div class="card dashboard-card">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-3">
                                                <h5 class="card-title mb-0">${plan.name}</h5>
                                                <span class="badge bg-${plan.is_active ? 'success' : 'danger'}">
                                                    ${plan.is_active ? 'Active' : 'Inactive'}
                                                </span>
                                            </div>
                                            
                                            <p class="card-text text-muted">${plan.description}</p>
                                            
                                            <div class="row mb-3">
                                                <div class="col-6">
                                                    <small class="text-muted">Min Investment</small>
                                                    <h6>₦${formatNumber(plan.min_amount)}</h6>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">Daily Interest</small>
                                                    <h6>${plan.daily_interest}%</h6>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">Duration</small>
                                                    <h6>${plan.duration} days</h6>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">Total Interest</small>
                                                    <h6>${plan.total_interest}%</h6>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <small class="text-muted">Features:</small>
                                                <div>
                                                    ${plan.features?.map(feature => `
                                                        <span class="badge bg-light text-dark me-1 mb-1">${feature}</span>
                                                    `).join('')}
                                                </div>
                                            </div>
                                            
                                            <div class="d-flex justify-content-between">
                                                <small class="text-muted">
                                                    <i class="fas fa-chart-line"></i> ${plan.investment_count || 0} investments
                                                </small>
                                                <small class="text-muted">
                                                    <i class="fas fa-money-bill"></i> ₦${formatNumber(plan.total_invested || 0)}
                                                </small>
                                            </div>
                                        </div>
                                        <div class="card-footer bg-transparent">
                                            <div class="btn-group w-100">
                                                <button class="btn btn-sm btn-outline-primary" onclick="editPlan('${plan._id}')">
                                                    <i class="fas fa-edit"></i> Edit
                                                </button>
                                                <button class="btn btn-sm btn-outline-${plan.is_active ? 'danger' : 'success'}" onclick="togglePlanStatus('${plan._id}', ${!plan.is_active})">
                                                    ${plan.is_active ? '<i class="fas fa-ban"></i> Deactivate' : '<i class="fas fa-check"></i> Activate'}
                                                </button>
                                                <button class="btn btn-sm btn-outline-info" onclick="viewPlanStats('${plan._id}')">
                                                    <i class="fas fa-chart-bar"></i> Stats
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } catch (error) {
                return `
                    <div class="alert alert-danger">
                        <h5>Error loading plans</h5>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function loadSupportTickets() {
            return `
                <div class="page-content">
                    <h5 class="mb-4">Support Tickets</h5>
                    
                    <div class="data-table-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6>All Tickets</h6>
                            <div class="btn-group">
                                <button class="btn btn-sm ${currentFilter === 'all' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('all')">All</button>
                                <button class="btn btn-sm ${currentFilter === 'open' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('open')">Open</button>
                                <button class="btn btn-sm ${currentFilter === 'in_progress' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('in_progress')">In Progress</button>
                                <button class="btn btn-sm ${currentFilter === 'resolved' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('resolved')">Resolved</button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover" id="supportTicketsTable">
                                <thead>
                                    <tr>
                                        <th>Ticket ID</th>
                                        <th>User</th>
                                        <th>Subject</th>
                                        <th>Category</th>
                                        <th>Priority</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="supportTicketsBody">
                                    <!-- Data will be loaded via AJAX -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadReferrals() {
            return `
                <div class="page-content">
                    <h5 class="mb-4">Referrals System</h5>
                    
                    <!-- Referral Stats -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stats-card-sm">
                                <div class="number" id="totalReferrals">0</div>
                                <div class="label">Total Referrals</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card-sm">
                                <div class="number" id="activeReferrals">0</div>
                                <div class="label">Active Referrals</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card-sm">
                                <div class="number">₦<span id="totalEarnings">0</span></div>
                                <div class="label">Total Earnings</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card-sm">
                                <div class="number" id="pendingEarnings">0</div>
                                <div class="label">Pending Earnings</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Top Referrers -->
                    <div class="data-table-container mb-4">
                        <h6>Top Referrers</h6>
                        <div class="table-responsive">
                            <table class="table table-hover" id="topReferrersTable">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Referrals</th>
                                        <th>Earnings</th>
                                        <th>Commission Rate</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="topReferrersBody">
                                    <!-- Data will be loaded via AJAX -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- All Referrals -->
                    <div class="data-table-container">
                        <h6>All Referrals</h6>
                        <div class="table-responsive">
                            <table class="table table-hover" id="allReferralsTable">
                                <thead>
                                    <tr>
                                        <th>Referrer</th>
                                        <th>Referred User</th>
                                        <th>Status</th>
                                        <th>Earnings</th>
                                        <th>Date</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="allReferralsBody">
                                    <!-- Data will be loaded via AJAX -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadNotifications() {
            return `
                <div class="page-content">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5>Notifications</h5>
                        <div>
                            <button class="btn btn-primary me-2" onclick="markAllNotificationsRead()">
                                <i class="fas fa-check-double"></i> Mark All Read
                            </button>
                            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#sendNotificationModal">
                                <i class="fas fa-paper-plane"></i> Send Notification
                            </button>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="data-table-container">
                                <h6>All Notifications</h6>
                                <div id="notificationsList">
                                    <!-- Notifications will be loaded here -->
                                    <div class="spinner-container">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-4">
                            <div class="data-table-container">
                                <h6>Send Quick Notification</h6>
                                <form id="quickNotificationForm">
                                    <div class="mb-3">
                                        <label class="form-label">Type</label>
                                        <select class="form-select" id="quickType">
                                            <option value="info">Information</option>
                                            <option value="success">Success</option>
                                            <option value="warning">Warning</option>
                                            <option value="promotional">Promotional</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Message</label>
                                        <textarea class="form-control" id="quickMessage" rows="4" placeholder="Enter your message..."></textarea>
                                    </div>
                                    <div class="d-grid">
                                        <button type="button" class="btn btn-primary" onclick="sendQuickNotification()">
                                            <i class="fas fa-paper-plane"></i> Send to All Users
                                        </button>
                                    </div>
                                </form>
                            </div>
                            
                            <div class="data-table-container mt-4">
                                <h6>Notification Stats</h6>
                                <div class="list-group">
                                    <div class="list-group-item d-flex justify-content-between">
                                        <span>Total Notifications</span>
                                        <strong id="totalNotifications">0</strong>
                                    </div>
                                    <div class="list-group-item d-flex justify-content-between">
                                        <span>Unread</span>
                                        <strong id="unreadNotifications">0</strong>
                                    </div>
                                    <div class="list-group-item d-flex justify-content-between">
                                        <span>Sent Today</span>
                                        <strong id="todayNotifications">0</strong>
                                    </div>
                                    <div class="list-group-item d-flex justify-content-between">
                                        <span>Sent This Week</span>
                                        <strong id="weekNotifications">0</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadAuditLogs() {
            return `
                <div class="page-content">
                    <h5 class="mb-4">Audit Logs</h5>
                    
                    <div class="data-table-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6>Admin Activities</h6>
                            <div class="btn-group">
                                <button class="btn btn-sm ${currentFilter === 'all' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('all')">All</button>
                                <button class="btn btn-sm ${currentFilter === 'today' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('today')">Today</button>
                                <button class="btn btn-sm ${currentFilter === 'week' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('week')">This Week</button>
                                <button class="btn btn-sm ${currentFilter === 'month' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setFilter('month')">This Month</button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover" id="auditLogsTable">
                                <thead>
                                    <tr>
                                        <th>Admin</th>
                                        <th>Action</th>
                                        <th>Target</th>
                                        <th>Details</th>
                                        <th>IP Address</th>
                                        <th>Timestamp</th>
                                    </tr>
                                </thead>
                                <tbody id="auditLogsBody">
                                    <!-- Data will be loaded via AJAX -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadSettings() {
            return `
                <div class="page-content">
                    <h5 class="mb-4">System Settings</h5>
                    
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="data-table-container mb-4">
                                <h6>Platform Settings</h6>
                                <form id="platformSettingsForm">
                                    <div class="mb-3">
                                        <label class="form-label">Platform Name</label>
                                        <input type="text" class="form-control" value="Raw Wealthy" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Platform Fee (%)</label>
                                        <input type="number" class="form-control" id="platformFee" value="10" min="0" max="100" step="0.1">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Referral Commission (%)</label>
                                        <input type="number" class="form-control" id="referralCommission" value="10" min="0" max="100" step="0.1">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Welcome Bonus (₦)</label>
                                        <input type="number" class="form-control" id="welcomeBonus" value="100" min="0">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Minimum Deposit (₦)</label>
                                        <input type="number" class="form-control" id="minDeposit" value="3500" min="0">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Minimum Withdrawal (₦)</label>
                                        <input type="number" class="form-control" id="minWithdrawal" value="3500" min="0">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Minimum Investment (₦)</label>
                                        <input type="number" class="form-control" id="minInvestment" value="3500" min="0">
                                    </div>
                                    <button type="button" class="btn btn-primary" onclick="updatePlatformSettings()">
                                        <i class="fas fa-save"></i> Save Settings
                                    </button>
                                </form>
                            </div>
                        </div>
                        
                        <div class="col-lg-6">
                            <div class="data-table-container mb-4">
                                <h6>Email Settings</h6>
                                <form id="emailSettingsForm">
                                    <div class="mb-3">
                                        <label class="form-label">SMTP Host</label>
                                        <input type="text" class="form-control" id="smtpHost" placeholder="smtp.gmail.com">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">SMTP Port</label>
                                        <input type="number" class="form-control" id="smtpPort" value="587">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">SMTP Username</label>
                                        <input type="email" class="form-control" id="smtpUsername" placeholder="your-email@gmail.com">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">SMTP Password</label>
                                        <input type="password" class="form-control" id="smtpPassword" placeholder="Your SMTP password">
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="emailEnabled">
                                        <label class="form-check-label" for="emailEnabled">
                                            Enable Email Notifications
                                        </label>
                                    </div>
                                    <button type="button" class="btn btn-primary" onclick="updateEmailSettings()">
                                        <i class="fas fa-save"></i> Save Email Settings
                                    </button>
                                    <button type="button" class="btn btn-info" onclick="testEmailSettings()">
                                        <i class="fas fa-paper-plane"></i> Test Email
                                    </button>
                                </form>
                            </div>
                            
                            <div class="data-table-container">
                                <h6>System Information</h6>
                                <div class="list-group">
                                    <div class="list-group-item d-flex justify-content-between">
                                        <span>Backend Version</span>
                                        <strong>v37.0.0</strong>
                                    </div>
                                    <div class="list-group-item d-flex justify-content-between">
                                        <span>Dashboard Version</span>
                                        <strong>v1.0.0</strong>
                                    </div>
                                    <div class="list-group-item d-flex justify-content-between">
                                        <span>API Status</span>
                                        <span class="badge bg-success">Online</span>
                                    </div>
                                    <div class="list-group-item d-flex justify-content-between">
                                        <span>Database</span>
                                        <span class="badge bg-success">Connected</span>
                                    </div>
                                    <div class="list-group-item">
                                        <button class="btn btn-sm btn-outline-primary w-100" onclick="checkSystemHealth()">
                                            <i class="fas fa-heartbeat"></i> Check System Health
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Initialize page components (charts, DataTables, etc.)
        function initializePageComponents() {
            // Destroy existing DataTables
            Object.values(dataTables).forEach(table => {
                if (table && $.fn.DataTable.isDataTable(table)) {
                    table.destroy();
                }
            });
            
            dataTables = {};
            
            // Initialize DataTables for each table on the page
            $('table').each(function() {
                const tableId = $(this).attr('id');
                if (tableId) {
                    dataTables[tableId] = $(this).DataTable({
                        pageLength: 10,
                        responsive: true,
                        order: [[0, 'desc']],
                        language: {
                            search: "Search:",
                            lengthMenu: "Show _MENU_ entries",
                            info: "Showing _START_ to _END_ of _TOTAL_ entries",
                            paginate: {
                                first: "First",
                                last: "Last",
                                next: "Next",
                                previous: "Previous"
                            }
                        }
                    });
                }
            });
            
            // Initialize charts on dashboard
            if (currentPage === 'dashboard') {
                initializeDashboardCharts();
            }
            
            // Load dynamic data for certain pages
            switch(currentPage) {
                case 'withdrawals':
                    loadWithdrawalsData();
                    break;
                case 'transactions':
                    loadTransactionsData();
                    break;
                case 'kyc':
                    loadKYCData();
                    break;
                case 'support':
                    loadSupportTicketsData();
                    break;
                case 'referrals':
                    loadReferralsData();
                    break;
                case 'notifications':
                    loadNotificationsData();
                    break;
                case 'audit-logs':
                    loadAuditLogsData();
                    break;
            }
        }

        function initializeDashboardCharts() {
            const ctx = document.getElementById('weeklyChart');
            if (ctx) {
                if (charts.weeklyChart) {
                    charts.weeklyChart.destroy();
                }
                
                charts.weeklyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                        datasets: [{
                            label: 'Deposits',
                            data: [12000, 19000, 15000, 25000, 22000, 30000, 28000],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'Withdrawals',
                            data: [8000, 12000, 10000, 15000, 18000, 22000, 20000],
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ₦${formatNumber(context.raw)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '₦' + formatNumber(value);
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Dynamic data loading functions
        async function loadWithdrawalsData() {
            try {
                const data = await makeRequest(API_ENDPOINTS.withdrawals);
                const tableBody = $('#withdrawalsBody');
                tableBody.empty();
                
                data.data?.withdrawals?.forEach(wdl => {
                    tableBody.append(`
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="user-avatar me-2">
                                        ${wdl.user?.full_name?.charAt(0) || 'U'}
                                    </div>
                                    <div>
                                        <strong>${wdl.user?.full_name || 'Unknown'}</strong><br>
                                        <small class="text-muted">${wdl.user?.email || ''}</small>
                                    </div>
                                </div>
                            </td>
                            <td><strong>₦${formatNumber(wdl.amount)}</strong></td>
                            <td>${wdl.payment_method}</td>
                            <td>
                                <span class="badge-status badge-${wdl.status}">
                                    ${wdl.status}
                                </span>
                            </td>
                            <td>${formatDate(wdl.createdAt)}</td>
                            <td>
                                ${wdl.status === 'pending' ? `
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-success" onclick="showActionModal('withdrawal', '${wdl._id}', 'approve')">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="btn btn-danger" onclick="showActionModal('withdrawal', '${wdl._id}', 'reject')">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                ` : `
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewWithdrawalDetails('${wdl._id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                `}
                            </td>
                        </tr>
                    `);
                });
                
                if (dataTables.withdrawalsTable) {
                    dataTables.withdrawalsTable.draw();
                }
            } catch (error) {
                console.error('Error loading withdrawals data:', error);
            }
        }

        async function loadTransactionsData() {
            try {
                const data = await makeRequest(API_ENDPOINTS.transactions);
                const tableBody = $('#transactionsBody');
                tableBody.empty();
                
                data.data?.transactions?.forEach(txn => {
                    tableBody.append(`
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="user-avatar me-2">
                                        ${txn.user_name?.charAt(0) || 'U'}
                                    </div>
                                    <div>
                                        <strong>${txn.user_name || 'System'}</strong><br>
                                        <small class="text-muted">${txn.user_email || ''}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-${getTransactionTypeColor(txn.type)}">
                                    ${txn.type}
                                </span>
                            </td>
                            <td class="${txn.amount > 0 ? 'text-success' : 'text-danger'}">
                                <strong>${txn.amount > 0 ? '+' : ''}₦${formatNumber(Math.abs(txn.amount))}</strong>
                            </td>
                            <td>${txn.description}</td>
                            <td>
                                <span class="badge-status badge-${txn.status}">
                                    ${txn.status}
                                </span>
                            </td>
                            <td>${formatDate(txn.createdAt, true)}</td>
                            <td>
                                ${txn.has_proof ? `
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewImage('${txn.proof_url}')">
                                        <i class="fas fa-image"></i>
                                    </button>
                                ` : '<span class="text-muted">No proof</span>'}
                            </td>
                        </tr>
                    `);
                });
                
                if (dataTables.transactionsTable) {
                    dataTables.transactionsTable.draw();
                }
            } catch (error) {
                console.error('Error loading transactions data:', error);
            }
        }

        async function loadKYCData() {
            try {
                const data = await makeRequest(API_ENDPOINTS.kyc);
                const tableBody = $('#kycBody');
                tableBody.empty();
                
                // This would need a proper KYC listing endpoint
                // For now, we'll show a message
                tableBody.append(`
                    <tr>
                        <td colspan="7" class="text-center">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> KYC data loading requires additional endpoint implementation
                            </div>
                        </td>
                    </tr>
                `);
                
                if (dataTables.kycTable) {
                    dataTables.kycTable.draw();
                }
            } catch (error) {
                console.error('Error loading KYC data:', error);
            }
        }

        // Action Functions
        async function viewUserDetails(userId) {
            try {
                const data = await makeRequest(API_ENDPOINTS.userDashboard(userId));
                
                if (!data.success) throw new Error(data.message);
                
                const user = data.data.user;
                const stats = data.data.dashboard_stats;
                
                $('#userDetailsContent').html(`
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card dashboard-card mb-3">
                                <div class="card-body text-center">
                                    <div class="user-avatar mx-auto mb-3" style="width: 80px; height: 80px; font-size: 2rem;">
                                        ${user.full_name.charAt(0)}
                                    </div>
                                    <h5>${user.full_name}</h5>
                                    <p class="text-muted">${user.email}</p>
                                    <div class="d-flex justify-content-center">
                                        <span class="badge bg-${user.is_active ? 'success' : 'danger'} me-2">
                                            ${user.is_active ? 'Active' : 'Inactive'}
                                        </span>
                                        <span class="badge bg-info">
                                            ${user.role}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card dashboard-card">
                                <div class="card-body">
                                    <h6>Account Information</h6>
                                    <table class="table table-sm">
                                        <tr>
                                            <td><strong>Phone:</strong></td>
                                            <td>${user.phone || 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Country:</strong></td>
                                            <td>${user.country || 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Currency:</strong></td>
                                            <td>${user.currency || 'NGN'}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Referral Code:</strong></td>
                                            <td>${user.referral_code || 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Joined:</strong></td>
                                            <td>${formatDate(user.createdAt)}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Last Login:</strong></td>
                                            <td>${user.last_login ? formatDate(user.last_login, true) : 'Never'}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-8">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="stats-card-sm">
                                        <div class="number">₦${formatNumber(stats.current_balance)}</div>
                                        <div class="label">Current Balance</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="stats-card-sm">
                                        <div class="number">₦${formatNumber(stats.portfolio_value)}</div>
                                        <div class="label">Portfolio Value</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="stats-card-sm">
                                        <div class="number">₦${formatNumber(stats.total_earnings)}</div>
                                        <div class="label">Total Earnings</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="stats-card-sm">
                                        <div class="number">₦${formatNumber(stats.daily_interest)}</div>
                                        <div class="label">Daily Interest</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card dashboard-card mb-3">
                                <div class="card-body">
                                    <h6>Bank Details</h6>
                                    ${user.bank_details ? `
                                        <table class="table table-sm">
                                            <tr>
                                                <td><strong>Bank Name:</strong></td>
                                                <td>${user.bank_details.bank_name || 'N/A'}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Account Name:</strong></td>
                                                <td>${user.bank_details.account_name || 'N/A'}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Account Number:</strong></td>
                                                <td>${user.bank_details.account_number || 'N/A'}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Verified:</strong></td>
                                                <td>
                                                    <span class="badge ${user.bank_details.verified ? 'bg-success' : 'bg-warning'}">
                                                        ${user.bank_details.verified ? 'Verified' : 'Not Verified'}
                                                    </span>
                                                </td>
                                            </tr>
                                        </table>
                                    ` : '<p class="text-muted">No bank details provided</p>'}
                                </div>
                            </div>
                            
                            <div class="card dashboard-card">
                                <div class="card-body">
                                    <h6>Quick Actions</h6>
                                    <div class="btn-group w-100">
                                        <button class="btn btn-primary" onclick="updateUserBalanceModal('${user._id}', '${user.full_name}', ${user.balance})">
                                            <i class="fas fa-coins"></i> Update Balance
                                        </button>
                                        <button class="btn btn-${user.is_active ? 'danger' : 'success'}" onclick="toggleUserStatus('${user._id}', ${!user.is_active})">
                                            ${user.is_active ? '<i class="fas fa-ban"></i> Deactivate' : '<i class="fas fa-check"></i> Activate'}
                                        </button>
                                        <button class="btn btn-info" onclick="changeUserRole('${user._id}')">
                                            <i class="fas fa-user-tag"></i> Change Role
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `);
                
                $('#userDetailsModal').modal('show');
            } catch (error) {
                toastr.error('Error loading user details: ' + error.message);
            }
        }

        function showActionModal(type, id, action) {
            const actionMap = {
                investment: 'Investment',
                deposit: 'Deposit',
                withdrawal: 'Withdrawal',
                kyc: 'KYC'
            };
            
            const actionText = action === 'approve' ? 'Approve' : 'Reject';
            $('#actionModalTitle').text(`${actionText} ${actionMap[type]}`);
            
            $('#actionModalContent').html(`
                <p>Are you sure you want to ${action} this ${type}?</p>
                <p><strong>ID:</strong> ${id}</p>
            `);
            
            $('#actionModal').data('type', type);
            $('#actionModal').data('id', id);
            $('#actionModal').data('action', action);
            $('#actionRemarks').val('');
            
            $('#actionModal').modal('show');
        }

        async function performApproveAction() {
            const type = $('#actionModal').data('type');
            const id = $('#actionModal').data('id');
            const remarks = $('#actionRemarks').val();
            
            let endpoint = '';
            switch(type) {
                case 'investment':
                    endpoint = API_ENDPOINTS.approveInvestment(id);
                    break;
                case 'deposit':
                    endpoint = API_ENDPOINTS.approveDeposit(id);
                    break;
                case 'withdrawal':
                    endpoint = API_ENDPOINTS.approveWithdrawal(id);
                    break;
                case 'kyc':
                    endpoint = API_ENDPOINTS.approveKYC(id);
                    break;
            }
            
            try {
                const data = await makeRequest(endpoint, 'POST', { remarks });
                
                if (data.success) {
                    toastr.success(`${type.charAt(0).toUpperCase() + type.slice(1)} approved successfully`);
                    $('#actionModal').modal('hide');
                    loadPage(currentPage);
                } else {
                    toastr.error(data.message);
                }
            } catch (error) {
                toastr.error('Error performing action: ' + error.message);
            }
        }

        async function performRejectAction() {
            const type = $('#actionModal').data('type');
            const id = $('#actionModal').data('id');
            const remarks = $('#actionRemarks').val();
            
            if (!remarks) {
                toastr.warning('Please provide rejection remarks');
                return;
            }
            
            let endpoint = '';
            switch(type) {
                case 'investment':
                    endpoint = API_ENDPOINTS.rejectInvestment(id);
                    break;
                case 'deposit':
                    endpoint = API_ENDPOINTS.rejectDeposit(id);
                    break;
                case 'withdrawal':
                    endpoint = API_ENDPOINTS.rejectWithdrawal(id);
                    break;
                case 'kyc':
                    endpoint = API_ENDPOINTS.rejectKYC(id);
                    break;
            }
            
            try {
                const data = await makeRequest(endpoint, 'POST', { remarks, rejection_reason: remarks });
                
                if (data.success) {
                    toastr.success(`${type.charAt(0).toUpperCase() + type.slice(1)} rejected successfully`);
                    $('#actionModal').modal('hide');
                    loadPage(currentPage);
                } else {
                    toastr.error(data.message);
                }
            } catch (error) {
                toastr.error('Error performing action: ' + error.message);
            }
        }

        function updateUserBalanceModal(userId, userName, currentBalance) {
            $('#balanceUserId').val(userId);
            $('#balanceUserName').val(userName);
            $('#currentBalance').val(`₦${formatNumber(currentBalance)}`);
            $('#balanceAmount').val('');
            $('#balanceDescription').val('');
            
            $('#updateBalanceModal').modal('show');
        }

        async function updateUserBalance() {
            const userId = $('#balanceUserId').val();
            const action = $('#balanceAction').val();
            const amount = parseFloat($('#balanceAmount').val());
            const description = $('#balanceDescription').val();
            
            if (!amount || amount <= 0) {
                toastr.warning('Please enter a valid amount');
                return;
            }
            
            if (!description) {
                toastr.warning('Please enter a description');
                return;
            }
            
            try {
                const data = await makeRequest(API_ENDPOINTS.updateBalance(userId), 'PUT', {
                    amount,
                    type: action,
                    description
                });
                
                if (data.success) {
                    toastr.success('Balance updated successfully');
                    $('#updateBalanceModal').modal('hide');
                    loadPage(currentPage);
                } else {
                    toastr.error(data.message);
                }
            } catch (error) {
                toastr.error('Error updating balance: ' + error.message);
            }
        }

        async function toggleUserStatus(userId, activate) {
            try {
                const data = await makeRequest(API_ENDPOINTS.updateUserStatus(userId), 'PUT', {
                    is_active: activate
                });
                
                if (data.success) {
                    toastr.success(`User ${activate ? 'activated' : 'deactivated'} successfully`);
                    loadPage(currentPage);
                } else {
                    toastr.error(data.message);
                }
            } catch (error) {
                toastr.error('Error updating user status: ' + error.message);
            }
        }

        async function changeUserRole(userId) {
            const newRole = prompt('Enter new role (user/admin/super_admin):');
            if (newRole && ['user', 'admin', 'super_admin'].includes(newRole.toLowerCase())) {
                try {
                    const data = await makeRequest(API_ENDPOINTS.updateUserRole(userId), 'PUT', {
                        role: newRole.toLowerCase()
                    });
                    
                    if (data.success) {
                        toastr.success('User role updated successfully');
                        loadPage(currentPage);
                    } else {
                        toastr.error(data.message);
                    }
                } catch (error) {
                    toastr.error('Error updating user role: ' + error.message);
                }
            } else {
                toastr.warning('Invalid role. Please enter: user, admin, or super_admin');
            }
        }

        async function verifyBankDetails(userId, verify) {
            try {
                const data = await makeRequest(API_ENDPOINTS.verifyBank(userId), 'POST', {
                    verified: verify
                });
                
                if (data.success) {
                    toastr.success(`Bank details ${verify ? 'verified' : 'unverified'} successfully`);
                    loadPage(currentPage);
                } else {
                    toastr.error(data.message);
                }
            } catch (error) {
                toastr.error('Error verifying bank details: ' + error.message);
            }
        }

        async function sendNotification() {
            const title = $('#notificationTitle').val();
            const message = $('#notificationMessage').val();
            const type = $('#notificationType').val();
            const target = $('#notificationTarget').val();
            const userId = target === 'specific' ? $('#specificUserId').val() : null;
            
            if (!title || !message) {
                toastr.warning('Please fill in all required fields');
                return;
            }
            
            try {
                const data = await makeRequest(API_ENDPOINTS.sendNotification, 'POST', {
                    user_id: userId,
                    title,
                    message,
                    type
                });
                
                if (data.success) {
                    toastr.success('Notification sent successfully');
                    $('#sendNotificationModal').modal('hide');
                    $('#notificationForm')[0].reset();
                    $('#specificUserField').hide();
                } else {
                    toastr.error(data.message);
                }
            } catch (error) {
                toastr.error('Error sending notification: ' + error.message);
            }
        }

        // Utility Functions
        function formatNumber(num) {
            if (!num) return '0';
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        function formatDate(dateString, includeTime = false) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            
            if (includeTime) {
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
            }
            return date.toLocaleDateString();
        }

        function formatIdType(idType) {
            const types = {
                'national_id': 'National ID',
                'passport': 'Passport',
                'driver_license': 'Driver License',
                'voters_card': 'Voter\'s Card'
            };
            return types[idType] || idType;
        }

        function getTransactionTypeColor(type) {
            const colors = {
                'deposit': 'success',
                'withdrawal': 'warning',
                'investment': 'info',
                'earning': 'success',
                'referral': 'primary',
                'bonus': 'info',
                'fee': 'danger',
                'refund': 'secondary',
                'transfer': 'dark'
            };
            return colors[type] || 'secondary';
        }

        function setFilter(filter) {
            currentFilter = filter;
            applyFilter();
        }

        function applyFilter() {
            // This would apply the filter to the current page's data
            // Implementation depends on the specific page
            loadPage(currentPage);
        }

        function filterCurrentPage(searchTerm) {
            if (dataTables[currentPage + 'Table']) {
                dataTables[currentPage + 'Table'].search(searchTerm).draw();
            }
        }

        function viewImage(url) {
            $('#previewImage').attr('src', url);
            $('#imagePreviewModal').modal('show');
        }

        function loadAdminProfile() {
            if (currentUser) {
                $('#adminInitials').text(currentUser.full_name.charAt(0));
                $('#adminName').text(currentUser.full_name);
                $('#adminRole').text(currentUser.role === 'super_admin' ? 'Super Admin' : 'Admin');
            }
        }

        // Initialize the application
        $(document).ready(function() {
            // Check if we're on login page or dashboard
            if (authToken) {
                loadPage('dashboard');
            }
        });
    </script>
</body>
    </html>
